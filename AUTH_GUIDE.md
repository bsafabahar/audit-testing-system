# راهنمای استفاده از سیستم احراز هویت

## نصب کتابخانه‌های جدید

ابتدا کتابخانه‌های جدید را نصب کنید:

```bash
pip install -r requirements.txt
```

## راه‌اندازی سیستم

1. **اجرای برنامه:**
```bash
python web_ui.py
```

2. **کاربر ادمین پیش‌فرض:**
هنگام اولین اجرا، یک کاربر ادمین پیش‌فرض ایجاد می‌شود:
- نام کاربری: `admin`
- رمز عبور: `admin123`
- **مهم:** حتماً پس از اولین ورود، رمز عبور را تغییر دهید!

## قابلیت‌های سیستم احراز هویت

### 1. ورود به سیستم
- آدرس: `http://localhost:5000/login`
- نام کاربری و رمز عبور خود را وارد کنید
- گزینه "مرا به خاطر بسپار" برای ماندگاری لاگین

### 2. ثبت نام
- آدرس: `http://localhost:5000/register`
- فیلدهای مورد نیاز:
  - نام کاربری (حداقل 3 کاراکتر، فقط حروف انگلیسی، اعداد و _)
  - ایمیل (باید معتبر باشد)
  - نام کامل (اختیاری)
  - رمز عبور (حداقل 6 کاراکتر)
  - تکرار رمز عبور

### 3. فراموشی رمز عبور
- آدرس: `http://localhost:5000/forgot-password`
- ایمیل خود را وارد کنید
- لینک بازیابی به ایمیل شما ارسال می‌شود
- لینک به مدت 1 ساعت معتبر است

**نکته:** برای کارکرد ارسال ایمیل، باید تنظیمات زیر را در متغیرهای محیطی یا کد تنظیم کنید:
```python
MAIL_SERVER = 'smtp.gmail.com'
MAIL_PORT = 587
MAIL_USE_TLS = True
MAIL_USERNAME = 'your-email@gmail.com'
MAIL_PASSWORD = 'your-app-password'
```

### 4. مدیریت کاربران (فقط برای ادمین)
- آدرس: `http://localhost:5000/manage-users`
- امکانات:
  - مشاهده لیست تمام کاربران
  - فعال/غیرفعال کردن کاربران
  - مشاهده اطلاعات کاربران (تاریخ ثبت، آخرین ورود، نقش)

### 5. خروج از سیستم
- دکمه "خروج" در هدر صفحه اصلی
- یا آدرس: `http://localhost:5000/logout`

## امنیت

### هش کردن رمز عبور
- تمام رمزهای عبور با استفاده از bcrypt هش می‌شوند
- رمزهای عبور به صورت متن ساده ذخیره نمی‌شوند

### محافظت از صفحات
- تمام صفحات سیستم با `@login_required` محافظت شده‌اند
- کاربران غیرمجاز به صفحه لاگین هدایت می‌شوند

### توکن بازیابی رمز
- توکن‌های بازیابی به صورت تصادفی تولید می‌شوند
- هر توکن فقط 1 ساعت معتبر است
- پس از استفاده، توکن از سیستم حذف می‌شود

## تنظیمات پیشرفته

### تغییر کلید امنیتی
در فایل `web_ui.py` یا متغیر محیطی:
```python
app.config['SECRET_KEY'] = 'your-secret-key-here'
```
یا:
```bash
export SECRET_KEY='your-secret-key-here'
```

### تنظیمات ایمیل
برای Gmail:
1. فعال کردن "Less secure app access" یا استفاده از App Password
2. تنظیم متغیرهای محیطی:
```bash
export MAIL_USERNAME='your-email@gmail.com'
export MAIL_PASSWORD='your-app-password'
```

## نقش‌های کاربری

### کاربر عادی
- دسترسی به تمام آزمون‌های حسابرسی
- مشاهده و اجرای تست‌ها
- دانلود نتایج

### مدیر (Admin)
- تمام دسترسی‌های کاربر عادی
- مدیریت کاربران
- فعال/غیرفعال کردن کاربران

## نکات مهم

1. **تغییر رمز ادمین:** حتماً پس از اولین اجرا، رمز عبور ادمین را تغییر دهید

2. **کلید امنیتی:** در محیط تولید (production)، حتماً کلید امنیتی قوی تنظیم کنید

3. **HTTPS:** در محیط تولید، از HTTPS استفاده کنید

4. **پشتیبان‌گیری:** از دیتابیس کاربران به صورت منظم پشتیبان‌گیری کنید

## عیب‌یابی

### مشکل در ارسال ایمیل
- بررسی تنظیمات SMTP
- بررسی فایروال و دسترسی به پورت 587
- استفاده از App Password برای Gmail

### مشکل در لاگین
- بررسی صحت نام کاربری و رمز عبور
- اطمینان از فعال بودن حساب کاربری
- پاک کردن کوکی‌های مرورگر

### خطای دیتابیس
- اطمینان از اجرای `python web_ui.py` برای ایجاد جداول
- بررسی مجوزهای دیتابیس

## ساختار دیتابیس

جدول کاربران (`users`) شامل فیلدهای زیر است:
- `id`: شناسه یکتا
- `username`: نام کاربری (یکتا)
- `email`: ایمیل (یکتا)
- `password_hash`: رمز عبور هش شده
- `full_name`: نام کامل
- `is_active`: وضعیت فعال/غیرفعال
- `is_admin`: نقش مدیر
- `created_at`: تاریخ ثبت
- `last_login`: آخرین ورود
- `reset_token`: توکن بازیابی رمز
- `reset_token_expiry`: انقضای توکن

## مثال استفاده از API

### ورود با Python requests
```python
import requests

# Login
session = requests.Session()
login_data = {
    'username': 'admin',
    'password': 'admin123'
}
response = session.post('http://localhost:5000/login', data=login_data)

# اجرای تست
test_response = session.post('http://localhost:5000/run-test/benford_first_digit_test')
print(test_response.json())
```

## پشتیبانی

برای مشکلات و سوالات، به فایل‌های زیر مراجعه کنید:
- `auth.py`: منطق احراز هویت
- `models.py`: مدل کاربر
- `web_ui.py`: روت‌های احراز هویت
