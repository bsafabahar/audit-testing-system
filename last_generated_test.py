"""
ุจูููุฑุฏ ุฑูู ุณูู
Benford Second Digit Analysis

ุจุฑุฑุณ ุชูุฒุน ุฑูู ุณูู ุฏุฑ ูุจุงูุบ ูุงู ุจุฑุง ุดูุงุณุง ููฺฉู ูุงููุงููฺฏโูุง
"""

from typing import List, Dict, Any
from models import Transaction
from parameters import param_string, param_number
from schema import col, schema
from query_runner import get_parameter
from types_definitions import QueryDefinition
from database import ReadOnlySession


# ุชูุฒุน ุจูููุฑุฏ ููุฑุฏ ุงูุชุธุงุฑ ุจุฑุง ุฑูู ุณูู
BENFORD_SECOND_DIGIT_EXPECTED = {
    0: 0.120,
    1: 0.114,
    2: 0.109,
    3: 0.104,
    4: 0.100,
    5: 0.097,
    6: 0.093,
    7: 0.090,
    8: 0.088,
    9: 0.085,
}


def define() -> QueryDefinition:
    """ุชุนุฑู ูพุงุฑุงูุชุฑูุง ู ุงุณฺฉูุง"""
    
    parameters = [
        param_string('transactionColumn', 'ูุงู ุณุชูู ูุจูุบ ุชุฑุงฺฉูุด', default_value='Debit'),
        param_number('minTransactions', 'ุญุฏุงูู ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง ุจุฑุง ุงุฌุฑุง', default_value=100),
    ]
    
    result_schema = schema(
        col('SecondDigit', 'ุฑูู ุณูู ูุจูุบ', 'integer'),
        col('ObservedFrequency', 'czฤstoลฤ ูุดุงูุฏู ุดุฏู', 'percent'),
        col('ExpectedFrequency', 'czฤstoลฤ ุงูุชุธุงุฑ', 'percent'),
        col('Difference', 'ุงุฎุชูุงู ุจู ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ', 'percent'),
    )
    
    return {
        'parameters': parameters,
        'schema': result_schema
    }


def execute(session: ReadOnlySession) -> List[Dict[str, Any]]:
    """ุงุฌุฑุง ุขุฒููู ุจูููุฑุฏ ุฑูู ุณูู"""
    
    # ุฏุฑุงูุช ูพุงุฑุงูุชุฑูุง
    transaction_column = get_parameter('transactionColumn', 'Debit')
    min_transactions = get_parameter('minTransactions', 100)
    
    # ุฏุฑุงูุช ุฏุงุฏููุง
    query = session.query(Transaction)
    results = query.all()
    
    # ุดูุงุฑุด ุฑูู ุณูู ูุจุงูุบ
    second_digit_counts = [0] * 10
    
    for t in results:
        amount = getattr(t, transaction_column, 0)
        if amount > 99:
            second_digit = (amount // 10) % 10
            second_digit_counts[second_digit] += 1
    
    # ุจุฑุฑุณ ุญุฏุงูู ุฏุงุฏู
    total_count = sum(second_digit_counts)
    if total_count < min_transactions:
        return [{
            'SecondDigit': 'ERROR',
            'ObservedFrequency': '',
            'ExpectedFrequency': '',
            'Difference': '',
            'Message': f'Not enough transactions (minimum {min_transactions})',
        }]
    
    # ูุญุงุณุจู ูุฑฺฉุงูุณโูุง ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ
    data = []
    for digit in range(10):
        observed_frequency = second_digit_counts[digit] / total_count
        expected_frequency = BENFORD_SECOND_DIGIT_EXPECTED[digit]
        difference = abs(observed_frequency - expected_frequency)
        
        row = {
            'SecondDigit': digit,
            'ObservedFrequency': round(observed_frequency, 4),
            'ExpectedFrequency': round(expected_frequency, 4),
            'Difference': round(difference, 4),
        }
        data.append(row)
    
    # ูุฑุชุจุณุงุฒ ุจุฑ ุงุณุงุณ ุฑูู ุณูู
    data.sort(key=lambda x: x['SecondDigit'])
    
    return data

---MARKDOWN_FILE---



```markdown
# ุจูููุฑุฏ ุฑูู ุณูู

## ๐ฏ ูุฏู ุขุฒููู

ุจุฑุฑุณ ุชูุฒุน ุฑูู ุณูู ุฏุฑ ูุจุงูุบ ูุงู ุจุฑุง ุดูุงุณุง ููฺฉู ูุงููุงููฺฏโูุง ู ุงุญุชูุงู ุชููุจ ุฏุฑ ุฏุงุฏูโูุง.

## ๐ก ฺุฑุง ุงุฒ ุงู ุขุฒููู ุฏุฑ ุญุณุงุจุฑุณ ุงุณุชูุงุฏู ูโุดูุฏุ

### ฺฉุงุฑุจุฑุฏูุง ุญุณุงุจุฑุณ:
1. **ุดูุงุณุง ูุงููุงููฺฏโูุง**: ุชุดุฎุต ูุงููุงููฺฏโูุง ููฺฉู ุฏุฑ ุฏุงุฏูโูุง ูุงู.
2. **ุชุญูู ุชููุจ**: ุจุฑุฑุณ ุงุญุชูุงู ุชููุจ ุฏุฑ ุฏุงุฏูโูุง ูุงู.
3. **ฺฉูุชุฑู ฺฉูุช ุฏุงุฏูโูุง**: ุงุทููุงู ุงุฒ ฺฉูุช ู ุตุญุช ุฏุงุฏูโูุง ูุงู.
4. **ุชุญูู ุฑุณฺฉ**: ุดูุงุณุง ููุงุท ุถุนู ุฏุฑ ุณุณุชูโูุง ูุงู ู ุฑุณฺฉโูุง ูุฑุชุจุท.

### ูุซุงูโูุง ฺฉุงุฑุจุฑุฏ:
- ุดูุงุณุง ูุงููุงููฺฏโูุง ูุงู ุฏุฑ ุณูุฏโูุง ุญุณุงุจุฑุณ.
- ุจุฑุฑุณ ุงุญุชูุงู ุชููุจ ุฏุฑ ุณูุฏโูุง ูุงู ุดุฑฺฉุชโูุง.
- ฺฉูุชุฑู ฺฉูุช ุฏุงุฏูโูุง ูุงู ุฏุฑ ุณุณุชูโูุง ุงุทูุงุนุงุช ุดุฑฺฉุชโูุง.

## ๐ฅ ูพุงุฑุงูุชุฑูุง ูุฑูุฏ

### 1. transactionColumn (ูุงู ุณุชูู ูุจูุบ ุชุฑุงฺฉูุด)
- **ููุน**: ุฑุดุชู (String)
- **ุงูุฒุงู**: ุจูู
- **ุชูุถุญุงุช**: ูุงู ุณุชูู ุงุฒ ุฌุฏูู ุชุฑุงฺฉูุดโูุง ฺฉู ูุจูุบ ุชุฑุงฺฉูุด ุฑุง ุดุงูู ูโุดูุฏ.
- **ููุฏุงุฑ ูพุดโูุฑุถ**: Debit
- **ููุงุฏุฑ ูุฌุงุฒ**:
  - Debit: ุจุฏูฺฉุงุฑ
  - Credit: ุจุณุชุงูฺฉุงุฑ

### 2. minTransactions (ุญุฏุงูู ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง ุจุฑุง ุงุฌุฑุง)
- **ููุน**: ุนุฏุฏ (Number)
- **ุงูุฒุงู**: ุจูู
- **ุชูุถุญุงุช**: ุญุฏุงูู ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง ููุฑุฏ ูุงุฒ ุจุฑุง ุงุฌุฑุง ุขุฒููู.
- **ููุฏุงุฑ ูพุดโูุฑุถ**: 100

## ๐ค ูพุงุฑุงูุชุฑูุง ุฎุฑูุฌ

### ุณุชููโูุง ุฎุฑูุฌ:

1. **SecondDigit (ุฑูู ุณูู ูุจูุบ)**
   - ุฑูู ุณูู ูุจูุบ ุชุฑุงฺฉูุด.
   - ููุน ุฏุงุฏู: ุนุฏุฏ ุตุญุญ (Integer).

2. **ObservedFrequency (czฤstoลฤ ูุดุงูุฏู ุดุฏู)**
   - ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ุจุฑุง ูุฑ ุฑูู ุณูู.
   - ููุน ุฏุงุฏู: ุฏุฑุตุฏ (Percent).

3. **ExpectedFrequency (czฤstoลฤ ุงูุชุธุงุฑ)**
   - ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ุจุฑ ุงุณุงุณ ูุงููู ุจูููุฑุฏ ุจุฑุง ูุฑ ุฑูู ุณูู.
   - ููุน ุฏุงุฏู: ุฏุฑุตุฏ (Percent).

4. **Difference (ุงุฎุชูุงู ุจู ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ)**
   - ุงุฎุชูุงู ุจู ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ ุจุฑุง ูุฑ ุฑูู ุณูู.
   - ููุน ุฏุงุฏู: ุฏุฑุตุฏ (Percent).

## ๐ ูุญูู ุงูุฌุงู ุขุฒููู

### ูุฑุงุญู ุงุฌุฑุง:

#### ูุฑุญูู 1: ุฏุฑุงูุช ูพุงุฑุงูุชุฑูุง
ุฏุฑ ุงู ูุฑุญูู ูพุงุฑุงูุชุฑูุง ูุฑูุฏ ุงุฒ ฺฉุงุฑุจุฑ ุฏุฑุงูุช ูโุดููุฏ.

```
transaction_column = get_parameter('transactionColumn', 'Debit')
min_transactions = get_parameter('minTransactions', 100)
```

#### ูุฑุญูู 2: ุฏุฑุงูุช ุฏุงุฏููุง
ุฏุงุฏูโูุง ุชุฑุงฺฉูุด ุงุฒ ุฏุชุงุจุณ ุฏุฑุงูุช ูโุดููุฏ.

```
query = session.query(Transaction)
results = query.all()
```

#### ูุฑุญูู 3: ุดูุงุฑุด ุฑูู ุณูู ูุจุงูุบ
ุจุฑุง ูุฑ ุชุฑุงฺฉูุดุ ุงฺฏุฑ ูุจูุบ ุจุดุชุฑ ุงุฒ 99 ุงุณุชุ ุฑูู ุณูู ุขู ุดูุฑุฏู ูโุดูุฏ.

```
second_digit_counts = [0] * 10

for t in results:
    amount = getattr(t, transaction_column, 0)
    if amount > 99:
        second_digit = (amount // 10) % 10
        second_digit_counts[second_digit] += 1
```

#### ูุฑุญูู 4: ูุญุงุณุจู ูุฑฺฉุงูุณโูุง ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ
ูุฑฺฉุงูุณโูุง ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ ุจุฑุง ูุฑ ุฑูู ุณูู ูุญุงุณุจู ูโุดููุฏ.

```
data = []
for digit in range(10):
    observed_frequency = second_digit_counts[digit] / total_count
    expected_frequency = BENFORD_SECOND_DIGIT_EXPECTED[digit]
    difference = abs(observed_frequency - expected_frequency)
    
    row = {
        'SecondDigit': digit,
        'ObservedFrequency': round(observed_frequency, 4),
        'ExpectedFrequency': round(expected_frequency, 4),
        'Difference': round(difference, 4),
    }
    data.append(row)
```

### ูุญุงุณุจุงุช:

**ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู:**
```
ูุฑููู = ุชุนุฏุงุฏ ููุงุฑุฏ ุจุง ุฑูู ุณูู ุฎุงุต / ุชุนุฏุงุฏ ฺฉู ููุงุฑุฏ
```

**ูุฑฺฉุงูุณ ุงูุชุธุงุฑ:**
```
ูุฑููู = ููุงุฏุฑ ุซุงุจุช ุจุฑ ุงุณุงุณ ูุงููู ุจูููุฑุฏ
```

## ๐ ุชูุณุฑ ูุชุงุฌ

### ูุนุงุฑูุง ุงุฑุฒุงุจ:

#### ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู:
- **ูุฑูุงู**: ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ูุฒุฏฺฉ ุจู ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ุงุณุช.
- **ูุงููููฺฏ**: ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ุฏูุฑ ุงุฒ ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ุงุณุช.

#### ูุฑฺฉุงูุณ ุงูุชุธุงุฑ:
- **ูุฑูุงู**: ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ุจุฑ ุงุณุงุณ ูุงููู ุจูููุฑุฏ ุงุณุช.

#### ุงุฎุชูุงู ุจู ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ:
- **ฺฉู**: ุงุฎุชูุงู ฺฉู ุงุณุช ู ูุดุงูโุฏููุฏู ููุงููฺฏ ุงุณุช.
- **ุฒุงุฏ**: ุงุฎุชูุงู ุฒุงุฏ ุงุณุช ู ูุดุงูโุฏููุฏู ูุงููุงููฺฏ ุงุณุช.

### ูุดุงููโูุง ูุดุฏุงุฑ (Red Flags):

โ๏ธ **ุงุฎุชูุงู ุจุฒุฑฺฏ**: ุงุฎุชูุงู ุจู ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ู ุงูุชุธุงุฑ ุจุฒุฑฺฏ ุงุณุช.
โ๏ธ **ูุฑฺฉุงูุณ ูุงููุงููฺฏ**: ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏู ุฏูุฑ ุงุฒ ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ุงุณุช.

## ๐ ูุซุงู ฺฉุงุฑุจุฑุฏ

### ุณูุงุฑู:
ุจุฑุฑุณ ุชูุฒุน ุฑูู ุณูู ุฏุฑ ูุจุงูุบ ุจุฏูฺฉุงุฑ ุชุฑุงฺฉูุดโูุง ุฏุฑ ุดุฑฺฉุช A.

### ุฏุงุฏูโูุง ูุฑูุฏ:
- transactionColumn: Debit
- minTransactions: 100

### ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:
ููุฑุณุช ุงุฒ ุฑููโูุง ุณูู ูุจูุบุ ูุฑฺฉุงูุณ ูุดุงูุฏู ุดุฏูุ ูุฑฺฉุงูุณ ุงูุชุธุงุฑ ู ุงุฎุชูุงู ุจู ุขูโูุง.

### ุชูุณุฑ:
ุจุฑุฑุณ ูุชุงุฌ ุจุฑุง ุชุดุฎุต ูุงููุงููฺฏโูุง ู ุงุญุชูุงู ุชููุจ ุฏุฑ ุฏุงุฏูโูุง ูุงู ุดุฑฺฉุช A.

## โ๏ธ ูพฺฉุฑุจูุฏ ูพุดููุงุฏ

### ุจุฑุง ุดุฑฺฉุชโูุง ูุงู:
- **transactionColumn**: Debit
- **minTransactions**: 100

### ุจุฑุง ุดุฑฺฉุชโูุง ฺฉูฺฺฉ:
- **transactionColumn**: Debit
- **minTransactions**: 50

## ๐ ูฺฉุงุช ููู

1. **ุญุฏุงูู ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง**: ุญุฏุงูู 100 ุชุฑุงฺฉูุด ุจุฑุง ุงุฌุฑุง ุขุฒููู ุถุฑูุฑ ุงุณุช.
2. **ููุน ุณุชูู ูุจูุบ**: ูุทูุฆู ุดูุฏ ฺฉู ุณุชูู ูุจูุบ ููุฑุฏ ูุธุฑ ุจู ุฏุฑุณุช ุงูุชุฎุงุจ ุดุฏู ุงุณุช.
3. **ุจุฑุฑุณ ูุชุงุฌ**: ูุชุงุฌ ุฑุง ุจุง ุฏูุช ุจุฑุฑุณ ฺฉูุฏ ู ูุดุงููโูุง ูุดุฏุงุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ.

## โ๏ธ ูุญุฏูุฏุชโูุง

1. **ูุญุฏูุฏุช ุชุนุฏุงุฏ ุฏุงุฏูโูุง**: ุงฺฏุฑ ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง ฺฉูุชุฑ ุงุฒ ุญุฏุงูู ููุฑุฏ ูุงุฒ ุจุงุดุฏุ ุขุฒููู ุงุฌุฑุง ูุฎูุงูุฏ ุดุฏ.
2. **ููุน ุฏุงุฏูโูุง**: ูุทูุฆู ุดูุฏ ฺฉู ุฏุงุฏูโูุง ูุจูุบ ุตุญุญ ู ุนุฏุฏ ุจุงุดูุฏ.
3. **ููุน ุณุชูู ูุจูุบ**: ุณุชูู ูุจูุบ ุจุงุฏ ุดุงูู ูุจูุบโูุง ูุงู ุจุงุดุฏ.

## ๐ ุขุฒูููโูุง ูุฑุชุจุท

- **ุขุฒููู ุจูููุฑุฏ ุฑูู ุงูู**: ุจุฑุฑุณ ุชูุฒุน ุฑูู ุงูู ุฏุฑ ูุจุงูุบ ูุงู.
- **ุขุฒููู ุจูููุฑุฏ ุฑูู ุฏูู**: ุจุฑุฑุณ ุชูุฒุน ุฑูู ุฏูู ุฏุฑ ูุจุงูุบ ูุงู.
- **ุขุฒููู ุชูุฒุน ูุจุงูุบ**: ุจุฑุฑุณ ุชูุฒุน ฺฉู ูุจุงูุบ ูุงู.

## ๐ ููุงุจุน ู ุงุณุชุงูุฏุงุฑุฏูุง

### ุงุณุชุงูุฏุงุฑุฏูุง ุญุณุงุจุฑุณ:
- ุงุณุชุงูุฏุงุฑุฏ ุญุณุงุจุฑุณ ูุงู
- ุงุณุชุงูุฏุงุฑุฏ ุญุณุงุจุฑุณ ูุงู ุจูโุงูููู

### ููุงุจุน ุนูู:
- Benford, F. (1938). The law of anomalous numbers. Proceedings of the American Philosophical Society, 78(4), 551-572.
- Nigrini, M. J. (1996). A taxpayer compliance application of Benfordโs law. Journal of the American Taxation Association, 18(1), 72-91.
```