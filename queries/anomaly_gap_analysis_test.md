# مستندات آزمون تحلیل فاصله‌ها و شکاف‌ها

## نام آزمون
**آزمون تحلیل شکاف‌های زمانی** (Gap Analysis Test)

## هدف و کاربرد در حسابرسی

### چرا از این آزمون استفاده می‌کنیم؟
فاصله‌ها یا شکاف‌های غیرعادی در تراکنش‌ها می‌توانند نشانه‌های مهمی از مشکلات باشند:
- **توقف فعالیت:** دوره‌هایی که هیچ تراکنشی ثبت نشده
- **دستکاری در سوابق:** حذف تراکنش‌های یک بازه زمانی
- **مشکلات سیستمی:** خرابی سیستم حسابداری
- **تعطیلی غیرمجاز:** بسته شدن موقت عملیات بدون مجوز
- **تقلب:** پنهان کردن تراکنش‌ها در یک دوره خاص

**در حسابرسی از این آزمون برای:**
- **تایید تداوم عملیات:** اطمینان از ثبت مستمر تراکنش‌ها
- **شناسایی دوره‌های مشکوک:** یافتن بازه‌های زمانی بدون فعالیت
- **ارزیابی کنترل‌های داخلی:** بررسی نظم و انضباط در ثبت
- **کشف تقلب:** شناسایی دوره‌هایی که ممکن است تراکنش‌ها حذف شده باشند

### کاربردهای عملی:
- بررسی تداوم فروش
- کنترل ثبت روزانه تراکنش‌ها
- شناسایی دوره‌های بدون فعالیت
- تایید عملیات مستمر کسب‌وکار

## پارامترهای ورودی

### 1. حداقل روز فاصله (minGapDays)
- **نوع:** عدد (Number)
- **مقدار پیش‌فرض:** 7 روز
- **توضیح:** حداقل تعداد روزهایی که یک فاصله باید داشته باشد تا در نتایج نمایش داده شود
- **مفهوم:**
  - 3-5 روز: شناسایی تعطیلات آخر هفته
  - 7-10 روز: شناسایی فاصله‌های هفتگی
  - 14-30 روز: شناسایی فاصله‌های متوسط
  - 30+ روز: شناسایی فاصله‌های طولانی
- **توصیه:** برای شروع از 7 روز استفاده کنید

## ستون‌های خروجی

### 1. GapStartDate (تاریخ شروع فاصله)
- آخرین تاریخی که قبل از شکاف تراکنش داشته است

### 2. GapEndDate (تاریخ پایان فاصله)
- اولین تاریخی که بعد از شکاف تراکنش داشته است

### 3. GapDays (روزهای فاصله)
- تعداد روزهای بین دو تاریخ
- هر چه بیشتر، شکاف بزرگ‌تر و مشکوک‌تر

### 4. TransactionsBefore (تراکنش‌های قبل)
- تعداد تراکنش‌های ثبت شده در تاریخ شروع فاصله

### 5. TransactionsAfter (تراکنش‌های بعد)
- تعداد تراکنش‌های ثبت شده در تاریخ پایان فاصله

### 6. AvgDailyBefore (میانگین روزانه قبل)
- میانگین تراکنش‌های روزانه در 7 روز قبل از شکاف
- برای مقایسه با الگوی طبیعی

### 7. AvgDailyAfter (میانگین روزانه بعد)
- میانگین تراکنش‌های روزانه در 7 روز بعد از شکاف
- برای بررسی بازگشت به حالت عادی

### 8. GapType (نوع فاصله)
- طبقه‌بندی شکاف:
  - `آخر هفته`: فاصله 1-3 روز در پنجشنبه/جمعه (طبیعی)
  - `فاصله کوتاه`: 7-13 روز
  - `فاصله متوسط`: 14-29 روز
  - `فاصله طولانی`: 30+ روز

## نحوه انجام آزمون

### مراحل اجرا:

1. **دریافت داده‌ها:**
   - تمام تراکنش‌ها از پایگاه داده خوانده می‌شوند
   - فقط تراکنش‌هایی که تاریخ دارند در نظر گرفته می‌شوند

2. **استخراج تاریخ‌ها:**
   - از هر تراکنش، تاریخ استخراج می‌شود
   - تاریخ‌ها به فرمت Date (بدون ساعت) تبدیل می‌شوند

3. **حذف تکراری و مرتب‌سازی:**
   - تاریخ‌های تکراری حذف می‌شوند
   - تاریخ‌های منحصر به فرد از کوچک به بزرگ مرتب می‌شوند

4. **شناسایی فاصله‌ها:**
   - برای هر جفت تاریخ متوالی:
     ```
     فاصله (روز) = تاریخ بعدی - تاریخ فعلی
     اگر فاصله ≥ حداقل آستانه:
         فاصله شناسایی شده
     ```

5. **محاسبه آمار:**
   - **تراکنش‌های قبل/بعد:** تعداد تراکنش‌ها در تاریخ شروع و پایان
   - **میانگین روزانه قبل:**
     ```
     بازه: 7 روز قبل از شروع فاصله تا شروع فاصله
     میانگین = تعداد تراکنش‌ها در بازه / 7
     ```
   - **میانگین روزانه بعد:**
     ```
     بازه: از پایان فاصله تا 7 روز بعد از پایان فاصله
     میانگین = تعداد تراکنش‌ها در بازه / 7
     ```

6. **تعیین نوع فاصله:**
   - **آخر هفته:** فاصله ≤ 3 روز و شروع در پنجشنبه یا بعد
   - **فاصله کوتاه:** 7-13 روز
   - **فاصله متوسط:** 14-29 روز
   - **فاصله طولانی:** 30+ روز

7. **مرتب‌سازی:**
   - نتایج بر اساس تعداد روز فاصله (بالا به پایین) مرتب می‌شوند

## تفسیر نتایج

### انواع فاصله‌ها:

#### فاصله آخر هفته (1-3 روز) - طبیعی
- **ویژگی‌ها:**
  - فاصله کوتاه در پایان هفته
  - شروع در پنجشنبه یا جمعه
- **احتمالات:**
  - تعطیلات هفتگی (طبیعی)
  - عدم فعالیت در روزهای تعطیل
- **سطح ریسک:** پایین
- **اقدام:** بررسی عادی

#### فاصله کوتاه (7-13 روز) - نیاز به بررسی
- **ویژگی‌ها:**
  - حدود یک هفته بدون تراکنش
- **احتمالات:**
  - تعطیلات رسمی
  - مشکل موقت سیستم
  - دوره کم‌فروش
- **سطح ریسک:** متوسط
- **اقدام:** بررسی علت و مستندسازی

#### فاصله متوسط (14-29 روز) - مشکوک
- **ویژگی‌ها:**
  - 2-4 هفته بدون فعالیت
- **احتمالات:**
  - توقف موقت عملیات
  - حذف تراکنش‌ها
  - مشکل جدی سیستمی
- **سطح ریسک:** بالا
- **اقدام:** تحقیق دقیق و یافتن علت

#### فاصله طولانی (30+ روز) - بسیار مشکوک
- **ویژگی‌ها:**
  - یک ماه یا بیشتر بدون تراکنش
- **احتمالات:**
  - تعطیلی عملیات
  - دستکاری در سوابق
  - تقلب سیستماتیک
- **سطح ریسک:** بسیار بالا
- **اقدام:** تحقیق فوری و جامع

### علائم خطر (Red Flags):

1. **کاهش ناگهانی میانگین بعد از فاصله:**
   - میانگین قبل: بالا
   - میانگین بعد: پایین یا صفر
   - نشانه توقف یا کاهش فعالیت

2. **فاصله در پایان دوره مالی:**
   - شکاف نزدیک به پایان ماه/سال
   - احتمال دستکاری در گزارش‌های مالی

3. **فاصله‌های مکرر با الگوی مشابه:**
   - چند فاصله با طول یکسان
   - احتمال مشکل سیستماتیک

4. **فاصله بعد از تراکنش‌های بزرگ:**
   - شکاف پس از تراکنش‌های پرمبلغ
   - احتمال پنهان کردن فعالیت‌های مرتبط

## مثال عملی

### سناریو:
بررسی تداوم فروش یک فروشگاه خرده‌فروشی

### تنظیمات:
- minGapDays: 7

### نتیجه نمونه:
```
شروع فاصله | پایان فاصله | روزها | تراکنش قبل | تراکنش بعد | میانگین قبل | میانگین بعد | نوع
2024-01-15   | 2024-02-20   | 36     | 150         | 120         | 142.5        | 95.3         | طولانی
2024-03-10   | 2024-03-25   | 15     | 200         | 180         | 195.7        | 175.2        | متوسط
2024-04-18   | 2024-04-26   | 8      | 180         | 190         | 185.3        | 188.6        | کوتاه
2024-05-02   | 2024-05-05   | 3      | 160         | 165         | 162.4        | 168.1        | آخر هفته
```

### تحلیل:

1. **فاصله 36 روز (15 ژانویه - 20 فوریه) - بحرانی:**
   - یک ماه و اندکی بدون تراکنش
   - میانگین قبل: 142.5 → میانگین بعد: 95.3 (کاهش 33%)
   - **تحقیق فوری:**
     - چرا 36 روز هیچ فروشی نبوده؟
     - آیا فروشگاه تعطیل بوده؟
     - آیا تراکنش‌ها حذف شده‌اند؟

2. **فاصله 15 روز (10-25 مارس) - مشکوک:**
   - دو هفته بدون فعالیت
   - میانگین نسبتاً ثابت مانده
   - **بررسی:**
     - آیا تعطیلات رسمی بوده؟
     - آیا مشکل سیستمی داشته‌اند؟

3. **فاصله 8 روز (18-26 آوریل) - عادی:**
   - یک هفته فاصله
   - میانگین ثابت
   - **احتمالاً طبیعی** (نیاز به تایید)

4. **فاصله 3 روز (2-5 مه) - طبیعی:**
   - آخر هفته
   - بدون تغییر در میانگین
   - **طبیعی**

### اقدامات پیشنهادی:
1. بررسی لاگ‌های سیستم برای فاصله 36 روز
2. مصاحبه با مدیریت درباره تعطیلات
3. بازیابی نسخه پشتیبان (اگر تراکنش‌ها حذف شده باشند)
4. بررسی صورت‌های بانکی برای همان دوره

## نکات مهم

### محدودیت‌ها:
- ❌ نمی‌تواند علت فاصله را تشخیص دهد
- ❌ در کسب‌وکارهای فصلی ممکن است false positive بالا باشد
- ❌ تعطیلات رسمی طبیعی را هم نشان می‌دهد

### بهترین کاربردها:
- ✅ کسب‌وکارهای با فعالیت مستمر
- ✅ فروشگاه‌های خرده‌فروشی
- ✅ شرکت‌های خدماتی
- ✅ بانک‌ها و موسسات مالی

### توصیه‌ها:
1. **تنظیم آستانه:** بر اساس نوع کسب‌وکار آستانه را تنظیم کنید
2. **در نظر گرفتن تعطیلات:** تعطیلات رسمی را از نتایج جدا کنید
3. **بررسی میانگین‌ها:** تغییر در میانگین‌ها نشانه مهمی است
4. **پیگیری فاصله‌های بزرگ:** هر فاصله بالای 14 روز را تحقیق کنید

### اقدامات پیشگیرانه:
- ثبت روزانه و مستمر تراکنش‌ها
- نگهداری لاگ سیستم
- پشتیبان‌گیری منظم
- گزارش‌گیری خودکار از فاصله‌ها

## ارتباط با سایر آزمون‌ها

- **آزمون ترتیب متوالی:** برای بررسی شکاف در شماره‌ها
- **آزمون رشد ناگهانی:** بررسی تغییرات قبل و بعد از فاصله
- **آزمون ثبت‌های پایان دوره:** فاصله‌ها در پایان دوره مشکوک‌تر هستند
- **آزمون تراکنش‌های آخر هفته:** برای تشخیص فاصله‌های طبیعی

## تحلیل الگوهای فاصله

### الگوهای طبیعی:
1. **فاصله‌های آخر هفته:** منظم هر هفته (طبیعی)
2. **فاصله‌های تعطیلات:** در زمان‌های مشخص سال (طبیعی)
3. **فاصله‌های فصلی:** در کسب‌وکارهای فصلی (طبیعی)

### الگوهای مشکوک:
1. **فاصله‌های نامنظم:** بدون دلیل مشخص
2. **فاصله پس از فعالیت بالا:** بعد از دوره شلوغ
3. **فاصله قبل از ممیزی:** نزدیک به تاریخ حسابرسی
4. **فاصله‌های با کاهش میانگین:** کاهش فعالیت بعد از فاصله
