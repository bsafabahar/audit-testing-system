# مستندات آزمون Z-Score

## نام آزمون
**آزمون شناسایی موارد پرت با Z-Score** (Z-Score Outlier Detection Test)

## هدف و کاربرد در حسابرسی

### Z-Score چیست؟
Z-Score یک معیار آماری است که نشان می‌دهد یک مقدار چند انحراف معیار از میانگین فاصله دارد. این روش برای شناسایی داده‌های غیرعادی یا پرت (Outlier) بسیار مفید است.

**فرمول:**
```
Z-Score = (مقدار - میانگین) / انحراف معیار
```

### چرا از این آزمون استفاده می‌کنیم؟
**در حسابرسی از این آزمون برای:**
- **شناسایی تراکنش‌های غیرعادی:** تراکنش‌هایی که به شدت از الگوی معمول فاصله دارند
- **تشخیص احتمال خطا یا تقلب:** مبالغ بسیار بالا یا پایین که نیاز به بررسی دارند
- **اولویت‌بندی حسابرسی:** تمرکز روی تراکنش‌های پرخطر
- **کنترل کیفیت:** شناسایی خطاهای ورود داده
- **تحلیل ریسک:** ارزیابی تراکنش‌های خارج از محدوده استاندارد

### کاربردهای عملی:
- بررسی فاکتورهای خرید یا فروش با مبالغ غیرعادی
- شناسایی پرداخت‌های مشکوک
- کنترل هزینه‌های غیرمعمول
- تشخیص خطاهای ثبت (اضافه یا کم کردن صفر)

## پارامترهای ورودی

### 1. نام ستون (columnName)
- **نوع:** متن (String)
- **مقدار پیش‌فرض:** 'Debit'
- **مقادیر مجاز:**
  - `Debit`: ستون بدهکار
  - `Credit`: ستون بستانکار
- **توضیح:** ستونی که می‌خواهید آزمون روی آن اجرا شود

### 2. آستانه Z-Score (zScoreThreshold)
- **نوع:** عدد اعشاری (Number)
- **مقدار پیش‌فرض:** 3.0
- **توضیح:** حد آستانه Z-Score برای شناسایی موارد پرت
- **تفسیر:**
  - **Z = 1:** حدود 68% داده‌ها در این محدوده (معمولی)
  - **Z = 2:** حدود 95% داده‌ها در این محدوده (نسبتاً معمولی)
  - **Z = 3:** حدود 99.7% داده‌ها در این محدوده (استاندارد)
  - **|Z| > 3:** فقط 0.3% داده‌ها خارج از این محدوده (غیرعادی)
- **توصیه:**
  - **حسابرسی عمومی:** 3.0
  - **تحلیل دقیق:** 2.5
  - **حساسیت بالا:** 2.0
  - **فقط موارد خیلی غیرعادی:** 4.0

## ستون‌های خروجی

### 1. TransactionID (شناسه تراکنش)
- کد یکتای تراکنش مشکوک

### 2. Amount (مبلغ)
- مبلغ تراکنش (بدهکار یا بستانکار بسته به پارامتر ورودی)

### 3. ZScore (Z-Score)
- مقدار Z-Score محاسبه شده
- مثبت: بالاتر از میانگین
- منفی: پایین‌تر از میانگین
- هر چه قدر مطلق بزرگ‌تر باشد، غیرعادی‌تر است

### 4. Mean (میانگین)
- میانگین کل مبالغ در مجموعه داده
- مرجع برای مقایسه

### 5. StdDev (انحراف معیار)
- انحراف معیار مبالغ
- نشان‌دهنده پراکندگی داده‌ها

### 6. DeviationFromMean (انحراف از میانگین)
- اختلاف مبلغ از میانگین (Amount - Mean)
- واحد: همان واحد مبلغ (ریال)

## نحوه انجام آزمون

### مراحل اجرا:

1. **جمع‌آوری داده‌ها:**
   - تمام تراکنش‌ها از پایگاه داده خوانده می‌شوند
   - بر اساس پارامتر columnName، مبالغ از ستون مناسب استخراج می‌شوند
   - فقط مقادیر مثبت در نظر گرفته می‌شوند

2. **محاسبه آمار پایه:**
   ```
   میانگین = مجموع مبالغ / تعداد
   واریانس = میانگین((مبلغ - میانگین)²)
   انحراف معیار = √واریانس
   ```

3. **محاسبه Z-Score:**
   - برای هر تراکنش:
     ```
     Z-Score = (مبلغ - میانگین) / انحراف معیار
     ```

4. **فیلتر کردن:**
   - فقط تراکنش‌هایی که |Z-Score| >= آستانه انتخاب می‌شوند

5. **مرتب‌سازی:**
   - بر اساس قدر مطلق Z-Score (بزرگ به کوچک)
   - بدترین موارد در ابتدا قرار می‌گیرند

## تفسیر نتایج

### سطوح Z-Score:

#### |Z| < 2 - عادی
- داده در محدوده 95% مرکزی
- احتمالاً معمولی و طبیعی

#### 2 ≤ |Z| < 3 - نسبتاً غیرعادی
- داده در 5% خارج از محدوده معمول
- نیاز به بررسی دارد
- ممکن است طبیعی یا مشکوک باشد

#### |Z| ≥ 3 - بسیار غیرعادی
- داده در 0.3% انتهایی
- بسیار مشکوک
- نیاز به بررسی دقیق و فوری

#### |Z| ≥ 4 - فوق‌العاده غیرعادی
- تقریباً غیرممکن در توزیع طبیعی
- احتمال بالای خطا یا تقلب
- بررسی اولویت اول

### علائم خطر:

1. **Z مثبت بسیار بالا (مثلاً +5):**
   - مبلغ خیلی بیشتر از معمول
   - احتمال:
     - اضافه شدن صفر اضافی
     - فاکتور جعلی با مبلغ بزرگ
     - خطای ثبت

2. **Z منفی بسیار پایین (مثلاً -4):**
   - مبلغ خیلی کمتر از معمول
   - احتمال:
     - کم شدن صفر
     - ثبت اشتباه در ستون

3. **چند Z-Score یکسان:**
   - الگوی سیستماتیک
   - احتمال تقلب برنامه‌ریزی شده

## مثال عملی

### سناریو:
بررسی فاکتورهای خرید یک شرکت

### تنظیمات:
- columnName: 'Debit'
- zScoreThreshold: 3.0

### داده‌های نمونه:
```
تعداد کل تراکنش‌ها: 1000
میانگین: 10,000,000 ریال
انحراف معیار: 2,000,000 ریال
```

### نتیجه نمونه:
```
ID   | مبلغ         | Z-Score | میانگین    | انحراف معیار | انحراف از میانگین
1001 | 100,000,000  | +45.0   | 10,000,000 | 2,000,000    | +90,000,000
2050 | 28,000,000   | +9.0    | 10,000,000 | 2,000,000    | +18,000,000
3100 | 500,000      | -4.75   | 10,000,000 | 2,000,000    | -9,500,000
4200 | 18,000,000   | +4.0    | 10,000,000 | 2,000,000    | +8,000,000
```

### تحلیل:

**تراکنش 1001 (Z = +45):**
- فوق‌العاده غیرعادی! 
- مبلغ 10 برابر میانگین
- **اقدام:** بررسی فوری فاکتور و مدارک
- احتمال: اضافه شدن یک صفر اضافی یا تقلب

**تراکنش 2050 (Z = +9):**
- بسیار غیرعادی
- مبلغ تقریباً 3 برابر میانگین
- **اقدام:** بررسی و تایید مدارک
- احتمال: خرید بزرگ یا خطا

**تراکنش 3100 (Z = -4.75):**
- خیلی کمتر از میانگین
- **اقدام:** بررسی صحت ثبت
- احتمال: حذف یک صفر یا ثبت در ستون اشتباه

## نکات مهم

### محدودیت‌ها:
- ❌ فرض می‌کند داده‌ها توزیع نرمال دارند (معمولاً در مالی صادق است)
- ❌ برای مجموعه داده‌های کوچک (کمتر از 30) قابل اعتماد نیست
- ❌ حساس به موارد پرت شدید (می‌تواند میانگین را تحت تاثیر قرار دهد)
- ❌ نمی‌تواند علت غیرعادی بودن را تشخیص دهد

### بهترین کاربردها:
- ✅ مجموعه داده‌های بزرگ (>100 رکورد)
- ✅ داده‌هایی که انتظار توزیع نرمال می‌رود
- ✅ تراکنش‌های مالی متنوع
- ✅ کنترل کیفیت ورودی داده

### توصیه‌ها:

1. **ترکیب با آزمون‌های دیگر:**
   - این آزمون فقط ناهنجاری آماری تشخیص می‌دهد
   - برای تایید، از آزمون‌های دیگر استفاده کنید

2. **بررسی دستی:**
   - همیشه موارد شناسایی شده را دستی بررسی کنید
   - دلایل تجاری معتبر ممکن است وجود داشته باشد

3. **تنظیم آستانه:**
   - برای داده‌های با پراکندگی زیاد: Z = 4
   - برای داده‌های یکنواخت: Z = 2.5

4. **مدیریت موارد پرت:**
   - گاهی موارد پرت طبیعی هستند (خرید دارایی ثابت)
   - از context تجاری غافل نشوید

### روش‌های جایگزین یا تکمیلی:
- **IQR (Interquartile Range):** کمتر حساس به موارد پرت شدید
- **Modified Z-Score:** استفاده از میانه به جای میانگین
- **Isolation Forest:** برای الگوهای پیچیده‌تر

## ارتباط با سایر آزمون‌ها

- **آزمون IQR:** روش جایگزین برای تشخیص موارد پرت
- **آزمون دو برابر/سه برابر:** برای موارد بسیار بزرگ
- **آزمون بنفورد:** برای تایید دستکاری در اعداد
- **آزمون معقول بودن داده:** برای کنترل کیفیت

## فرمول‌های آماری

### محاسبه دستی:

**مثال:**
داده‌ها: [10, 12, 11, 13, 50]

1. **میانگین:**
   ```
   (10 + 12 + 11 + 13 + 50) / 5 = 19.2
   ```

2. **انحراف معیار:**
   ```
   واریانس = [(10-19.2)² + (12-19.2)² + (11-19.2)² + (13-19.2)² + (50-19.2)²] / 5
            = [84.64 + 51.84 + 67.24 + 38.44 + 950.44] / 5
            = 238.52
   
   انحراف معیار = √238.52 = 15.44
   ```

3. **Z-Score برای 50:**
   ```
   Z = (50 - 19.2) / 15.44 = 30.8 / 15.44 = 1.99
   ```

با آستانه 3، مقدار 50 هنوز در محدوده عادی است، اما با آستانه 2 غیرعادی محسوب می‌شود.
