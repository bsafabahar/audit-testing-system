<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</title>
    <!-- Vazir Persian Font from official CDN -->
    <!-- This is the official repository for Vazir font: https://github.com/rastikerdar/vazir-font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" type="text/css" />
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            text-align: right;
        }

        .header h1 {
            font-size: 1.3em;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.95;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: left;
            font-size: 0.9em;
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .user-role {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-manage-users {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .btn-manage-users:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Layout: Tree Menu (Right) + Content Area (Left) */
        .main-content {
            display: flex;
            flex: 1;
            overflow: visible;
        }

        /* Content Area - Contains Top Panel & Results */
        .content-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: visible;
        }

        /* Top Panel - Settings & Files */
        .top-panel {
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            padding: 20px;
            overflow: visible;
        }

        .top-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-info {
            margin-bottom: 15px;
        }

        .test-info h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .test-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.95em;
        }

        .upload-section {
            margin-top: 15px;
        }

        .upload-box {
            background: white;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: #f8f9fa;
            border-color: #764ba2;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .file-status {
            margin-top: 15px;
        }

        .file-item {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.success {
            background: #d4edda;
            border-right: 4px solid #28a745;
        }

        .file-item.error {
            background: #f8d7da;
            border-right: 4px solid #dc3545;
        }

        /* Bottom Content: Tree Menu (Right) + Results (Left) */
        .bottom-content {
            display: flex;
            flex: 1;
            overflow: visible;
        }

        /* Results Area (Left/Main) */
        .results-area {
            flex: 1;
            padding: 20px;
            overflow: visible;
            background: #fafafa;
        }

        .results-area h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border-right: 5px solid #667eea;
        }

        .result-card.success {
            border-right-color: #28a745;
        }

        .result-card.error {
            border-right-color: #dc3545;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 1.3em;
            font-weight: bold;
        }

        .interpretation-box {
            background: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .interpretation-box h5 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .interpretation-box p {
            color: #856404;
            line-height: 1.6;
        }

        .result-table {
            overflow-x: auto;
            margin-top: 15px;
        }

        .result-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .result-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: right;
            font-weight: bold;
        }

        .result-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            text-align: right;
        }

        .result-table tr:hover {
            background: #f8f9fa;
        }

        /* Tree Menu (Right Sidebar) */
        .tree-menu {
            width: 350px;
            min-width: 350px;
            background: #ffffff;
            border-left: 3px solid #667eea;
            overflow: visible;
            padding: 20px;
            flex-shrink: 0;
        }

        .tree-menu h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* View Toggle Buttons */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .view-btn {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .view-btn span:first-child {
            font-size: 1.3em;
        }

        .view-btn:hover {
            background: #e7f3ff;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        .tree-category {
            margin-bottom: 10px;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            font-weight: bold;
        }

        .category-header:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .category-header.active {
            border-radius: 8px 8px 0 0;
        }

        .category-count {
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .test-list {
            display: none;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .test-list.active {
            display: block;
        }

        .test-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-item:hover {
            background: #e7f3ff;
            padding-right: 20px;
        }

        .test-item.selected {
            background: #d4edda;
            font-weight: bold;
        }

        .test-icon {
            font-size: 1.2em;
        }

        .test-name {
            flex: 1;
            font-size: 0.95em;
        }

        /* Action Buttons (Above Results) */
        .action-buttons-container {
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            border-bottom: 3px solid #667eea;
            padding: 15px 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .btn-run {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-run:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-run:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-run:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn-secondary {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
        }

        .btn-fix-error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .btn-fix-error:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            background: linear-gradient(135deg, #ff5252 0%, #e63946 100%);
        }

        .btn-fix-error:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading & Progress */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .no-selection {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-selection-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Info Button */
        .info-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }

        .info-btn:hover {
            background: #138496;
            transform: scale(1.1);
        }

        .refresh-custom-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .refresh-custom-btn:hover {
            background: #218838;
        }

        .refresh-custom-btn:active {
            background: #1e7e34;
        }

        .custom-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .custom-header h4 {
            margin: 0;
            font-size: 1.2em;
        }

        .custom-header .refresh-custom-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
            height: auto;
        }

        .custom-header .refresh-custom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .no-custom-tests {
            padding: 40px 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .empty-icon {
            font-size: 4em;
            display: block;
            margin-bottom: 20px;
        }

        .empty-state p {
            margin: 10px 0;
            color: #6c757d;
        }

        .empty-state .hint {
            font-size: 0.9em;
            color: #adb5bd;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            direction: rtl;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            line-height: 1.8;
        }

        /* Markdown Styling */
        .markdown-content h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-top: 20px;
            font-size: 1.8em;
        }

        .markdown-content h2 {
            color: #764ba2;
            margin-top: 25px;
            font-size: 1.5em;
            border-right: 4px solid #764ba2;
            padding-right: 15px;
        }

        .markdown-content h3 {
            color: #667eea;
            margin-top: 20px;
            font-size: 1.3em;
        }

        .markdown-content p {
            margin: 15px 0;
            text-align: justify;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-right: 30px;
        }

        .markdown-content li {
            margin: 8px 0;
        }

        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .markdown-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid #667eea;
            overflow-x: auto;
        }

        .markdown-content blockquote {
            background: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .markdown-content th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: right;
        }

        .markdown-content td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
        }

        .markdown-content tr:nth-child(even) {
            background: #f8f9fa;
        }

        .loading-modal {
            text-align: center;
            padding: 40px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .tree-menu {
                width: 300px;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .tree-menu {
                width: 100%;
                min-width: auto;
                max-height: 300px;
                border-left: none;
                border-bottom: 3px solid #667eea;
                order: -1;
            }

            .container {
                height: auto;
            }
        }

        /* Parameter Forms */
        .parameters-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #dee2e6;
        }

        .parameters-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .parameter-form {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .param-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .param-label {
            font-weight: 600;
            color: #333;
            font-size: 1.05em;
        }

        .param-required {
            color: #dc3545;
            margin-right: 5px;
        }

        .param-input,
        .param-select {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Vazir', 'Tahoma', sans-serif;
            transition: all 0.3s;
            background: white;
        }

        .param-input:focus,
        .param-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .param-checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .param-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .test-parameters-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .test-parameters-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .test-parameters-header h4 {
            color: #495057;
            font-size: 1.2em;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1>ğŸ¯ Ø³ÛŒØ³ØªÙ… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</h1>
                <p>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§: <strong>{{ total_tests }}</strong> Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø± <strong>{{ total_categories }}</strong> Ø¯Ø³ØªÙ‡</p>
            </div>
            <div class="header-user">
                <div class="user-info">
                    <div class="user-name">{{ current_user.full_name or current_user.username }}</div>
                    <div class="user-role">{% if current_user.is_admin %}Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…{% else %}Ú©Ø§Ø±Ø¨Ø±{% endif %}</div>
                </div>
                <div>
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('manage_users') }}" class="btn-manage-users">ğŸ‘¥ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a>
                    {% endif %}
                    <a href="{{ url_for('test_generator_page') }}" class="btn-manage-users">ğŸ¤– Ø¢Ø²Ù…ÙˆÙ†â€ŒØ³Ø§Ø²</a>
                    <a href="{{ url_for('change_password') }}" class="btn-manage-users">ğŸ”‘ ØªØºÛŒÛŒØ± Ø±Ù…Ø²</a>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Ø®Ø±ÙˆØ¬ ğŸšª</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Tree Menu (Right Sidebar) - Full Height -->
            <div class="tree-menu">
                <h3>ğŸ“‚ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h3>
                
                <!-- View Toggle Buttons -->
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('category')" id="viewBtnCategory">
                        <span>ğŸ“‚</span>
                        <span>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÙˆØ¶ÙˆØ¹ÛŒ</span>
                    </button>
                    <button class="view-btn" onclick="switchView('subsystem')" id="viewBtnSubsystem">
                        <span>ğŸ¦</span>
                        <span>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²ÛŒØ±Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</span>
                    </button>
                    <button class="view-btn" onclick="switchView('custom')" id="viewBtnCustom">
                        <span>ğŸ”¬</span>
                        <span>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ</span>
                    </button>
                </div>

                <!-- Category View -->
                <div class="view-content active" id="categoryView">
                    {% for category_id, category in audit_tests.items() %}
                    {% if category_id != 'custom' %}
                    <div class="tree-category">
                        <div class="category-header" onclick="toggleCategory('{{ category_id }}')">
                            <span>{{ category.name }}</span>
                            <span class="category-count">{{ category.tests|length }}</span>
                        </div>
                        <div class="test-list" id="list-{{ category_id }}">
                            {% for test in category.tests %}
                            <div class="test-item" id="item-{{ test.id }}">
                                <button class="info-btn" onclick="event.stopPropagation(); showTestInfo('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')" title="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±">â„¹ï¸</button>
                                <span class="test-icon" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.icon }}</span>
                                <span class="test-name" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Subsystem View -->
                <div class="view-content" id="subsystemView">
                    {% for subsystem_id, subsystem in subsystems.items() %}
                    <div class="tree-category">
                        <div class="category-header" onclick="toggleCategory('sub-{{ subsystem_id }}')">
                            <span>{{ subsystem.icon }} {{ subsystem.name }}</span>
                            <span class="category-count">{{ subsystem.tests|length }}</span>
                        </div>
                        <div class="test-list" id="list-sub-{{ subsystem_id }}">
                            {% for test in subsystem.tests %}
                            <div class="test-item" id="item-sub-{{ subsystem_id }}-{{ test.id }}">
                                <button class="info-btn" onclick="event.stopPropagation(); showTestInfo('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')" title="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±">â„¹ï¸</button>
                                <span class="test-icon" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.icon }}</span>
                                <span class="test-name" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Custom Tests View -->
                <div class="view-content" id="customView">
                    <div class="custom-header">
                        <h4>ğŸ”¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ Ø´Ù…Ø§</h4>
                    </div>
                    
                    {% if audit_tests.get('custom') %}
                    <div class="custom-tests-container">
                        <div class="test-list" style="display: block;">
                            {% for test in audit_tests.custom.tests %}
                            <div class="test-item" id="item-custom-{{ test.id }}">
                                <button class="info-btn" onclick="event.stopPropagation(); showTestInfo('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')" title="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±">â„¹ï¸</button>
                                <span class="test-icon" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.icon }}</span>
                                <span class="test-name" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="no-custom-tests">
                        <div class="empty-state">
                            <span class="empty-icon">ğŸ“­</span>
                            <p>Ù‡Ù†ÙˆØ² Ø¢Ø²Ù…ÙˆÙ† Ø´Ø®ØµÛŒâ€ŒØ§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                            <p class="hint">Ø§Ø² Ø¨Ø®Ø´ "Ø¢Ø²Ù…ÙˆÙ†â€ŒØ³Ø§Ø²" Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Content Area - Settings & Results -->
            <div class="content-area">
                <!-- Top Panel: Settings & File Upload -->
                <div class="top-panel">
                    <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†</h3>
                    
                    <div class="settings-section">
                        <div class="test-info">
                            <h4>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</h4>
                            <div id="selectedTestBadges">
                                <div class="no-selection">
                                    <div class="no-selection-icon">ğŸ“‹</div>
                                    <p>Ù‡ÛŒÚ† Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                                    <p style="font-size: 0.9em; margin-top: 10px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                                </div>
                            </div>
                        </div>

                        <div class="upload-section" id="uploadSection" style="display: none;">
                            <h4>ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡:</h4>
                            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="uploadFiles()">
                                <div class="upload-icon">ğŸ“</div>
                                <h3>Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯</h3>
                                <p>ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²: Excel (.xlsx, .xls)</p>
                            </div>
                            <div class="file-status" id="fileStatus"></div>
                        </div>

                        <!-- Parameters Section -->
                        <div class="parameters-section" id="parametersSection" style="display: none;">
                            <h3>
                                <span>âš™ï¸</span>
                                <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†</span>
                            </h3>
                            <div id="parametersContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Run Buttons (Above Results) -->
                <div class="action-buttons-container">
                    <button class="btn-secondary" onclick="resetAll()">ğŸ”„ Ø±ÛŒØ³Øª Ù‡Ù…Ù‡</button>
                    <button class="btn-run" id="btnRun" onclick="runTests()" disabled>
                        â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†
                    </button>
                </div>

                <!-- Results Area -->
                <div class="bottom-content">
                    <div class="results-area">
                        <h3>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†</h3>
                        <div id="resultsContainer">
                            <div class="no-selection">
                                <div class="no-selection-icon">ğŸ“ˆ</div>
                                <p>Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ØŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ“– Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø²Ù…ÙˆÙ†</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="modalContent" class="markdown-content">
                    <div class="loading-modal">
                        <div class="spinner"></div>
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedTests = new Map();
        let uploadedFiles = new Map();
        let testResults = [];

        // Toggle category expansion
        function toggleCategory(categoryId) {
            const list = document.getElementById('list-' + categoryId);
            const header = list.previousElementSibling;
            
            if (list.classList.contains('active')) {
                list.classList.remove('active');
                header.classList.remove('active');
            } else {
                list.classList.add('active');
                header.classList.add('active');
            }
        }

        // Switch between category and subsystem views
        function switchView(viewType) {
            console.log('ğŸ”„ switchView called with:', viewType);
            
            const categoryView = document.getElementById('categoryView');
            const subsystemView = document.getElementById('subsystemView');
            const customView = document.getElementById('customView');
            const categoryBtn = document.getElementById('viewBtnCategory');
            const subsystemBtn = document.getElementById('viewBtnSubsystem');
            const customBtn = document.getElementById('viewBtnCustom');

            console.log('ğŸ“¦ customView element:', customView);
            console.log('ğŸ“¦ customView innerHTML length:', customView ? customView.innerHTML.length : 'null');

            // Remove active from all
            categoryView.classList.remove('active');
            subsystemView.classList.remove('active');
            customView.classList.remove('active');
            categoryBtn.classList.remove('active');
            subsystemBtn.classList.remove('active');
            customBtn.classList.remove('active');

            // Add active to selected
            if (viewType === 'category') {
                categoryView.classList.add('active');
                categoryBtn.classList.add('active');
            } else if (viewType === 'subsystem') {
                subsystemView.classList.add('active');
                subsystemBtn.classList.add('active');
            } else if (viewType === 'custom') {
                customView.classList.add('active');
                customBtn.classList.add('active');
                console.log('âœ… customView is now active');
                console.log('ğŸ“‹ Test items in customView:', customView.querySelectorAll('.test-item').length);
            }
        }

        // Refresh custom tests
        async function refreshCustomTests() {
            const btn = event.target;
            btn.disabled = true;
            
            try {
                const response = await fetch('/refresh-custom-tests');
                const data = await response.json();
                
                if (data.success) {
                    // Ø±ÙØ±Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± ØµÙØ­Ù‡
                    window.location.reload();
                } else {
                    alert('âŒ Ø®Ø·Ø§: ' + data.error);
                    btn.disabled = false;
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯: ' + error.message);
                btn.disabled = false;
            }
        }

        // Show test info modal
        async function showTestInfo(testId, testName, testIcon) {
            const modal = document.getElementById('infoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.innerHTML = `${testIcon} ${testName}`;
            modalContent.innerHTML = `
                <div class="loading-modal">
                    <div class="spinner"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            `;
            
            modal.classList.add('active');
            
            try {
                const response = await fetch(`/test-description/${testId}`);
                const data = await response.json();
                
                if (data.success && data.description) {
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² marked.js Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ markdown Ø¨Ù‡ HTML
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            breaks: true,
                            gfm: true
                        });
                        modalContent.innerHTML = marked.parse(data.description);
                    } else {
                        // ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø¯Ù‡ Ø§Ú¯Ø± marked.js Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡
                        let html = data.description;
                        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
                        html = html.replace(/^## (.+)$/gm, '<h2>$2</h2>');
                        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
                        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                        html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
                        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                        html = html.split('\n\n').map(para => '<p>' + para + '</p>').join('\n');
                        modalContent.innerHTML = html;
                    }
                } else {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: #dc3545; font-size: 1.2em;">âš ï¸ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                            <p style="color: #6c757d; margin-top: 10px;">ÙØ§ÛŒÙ„ ${testId}.md Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>
                        </div>
                    `;
                }
            } catch (error) {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545; font-size: 1.2em;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>
                        <p style="color: #6c757d; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.remove('active');
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Select/deselect test (Single Selection Only)
        async function selectTest(testId, testName, testIcon) {
            // Handle both category and subsystem view items
            const categoryItem = document.getElementById('item-' + testId);
            
            // Get all subsystem view instances of this test
            const allItems = document.querySelectorAll(`[id*="-${testId}"]`);
            
            // Ø§Ú¯Ø± Ù‡Ù…ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø§ Ù„ØºÙˆ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (selectedTests.has(testId)) {
                selectedTests.clear();
                // Remove selected class from all items
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.classList.remove('selected');
                });
            } else {
                // Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨Ù„ÛŒ
                selectedTests.clear();
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Ø¯Ø±ÛŒØ§ÙØª Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ†
                try {
                    const response = await fetch(`/test-requirements/${testId}`);
                    const data = await response.json();
                    const requirements = data.success ? data.requirements : null;
                    
                    selectedTests.set(testId, { 
                        name: testName, 
                        icon: testIcon,
                        requirements: requirements 
                    });
                } catch (error) {
                    selectedTests.set(testId, { 
                        name: testName, 
                        icon: testIcon,
                        requirements: null
                    });
                }
                // Add selected class to all instances
                if (categoryItem) categoryItem.classList.add('selected');
                allItems.forEach(item => item.classList.add('selected'));
            }
            
            updateSelectedBadges();
            updateRunButton();
        }

        // Update selected test badges in top panel
        async function updateSelectedBadges() {
            const container = document.getElementById('selectedTestBadges');
            const uploadSection = document.getElementById('uploadSection');
            
            if (selectedTests.size === 0) {
                container.innerHTML = `
                    <div class="no-selection">
                        <div class="no-selection-icon">ğŸ“‹</div>
                        <p>Ù‡ÛŒÚ† Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                    </div>
                `;
                uploadSection.style.display = 'none';
                return;
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            let html = '<div style="margin-bottom: 15px;">';
            selectedTests.forEach((test, id) => {
                html += `<span class="test-badge">${test.icon} ${test.name}</span>`;
            });
            html += '</div>';
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            html += `<div id="filesRequiredBox" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center;">
                <span style="color: #667eea;">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²...</span>
            </div>`;
            
            container.innerHTML = html;
            
            // Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
            const testIds = Array.from(selectedTests.keys());
            try {
                const response = await fetch('/tests-requirements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_ids: testIds })
                });
                const data = await response.json();
                
                console.log('Requirements response:', data);
                
                let filesHtml = '';
                if (data.success && data.files && data.files.length > 0) {
                    filesHtml = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 10px; font-size: 1.05em;">ğŸ“‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</h4>
                            <div style="color: #856404; font-size: 0.95em; line-height: 1.8;">
                    `;
                    data.files.forEach(file => {
                        filesHtml += `<div style="padding: 5px 0; font-weight: bold;">âœ“ ${file}</div>`;
                    });
                    filesHtml += `
                            </div>
                            <p style="margin-top: 10px; font-size: 0.85em; color: #856404; font-style: italic;">
                                ğŸ’¡ Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ù¾ÙˆØ´Ù‡ excel_sample_data Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
                            </p>
                        </div>
                    `;
                } else {
                    filesHtml = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #dc3545;">
                            <p style="color: #721c24;">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                        </div>
                    `;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§Ú©Ø³
                const filesBox = document.getElementById('filesRequiredBox');
                if (filesBox) {
                    filesBox.outerHTML = filesHtml;
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§:', error);
                const filesBox = document.getElementById('filesRequiredBox');
                if (filesBox) {
                    filesBox.outerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #dc3545;">
                            <p style="color: #721c24;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ${error.message}</p>
                        </div>
                    `;
                }
            }
            
            uploadSection.style.display = 'block';
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§
            await loadTestParameters();
        }

        // Upload files
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;

            const statusDiv = document.getElementById('fileStatus');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§...</p></div>';

            let resultsHtml = '';
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success || result.records) {
                        uploadedFiles.set(file.name, result.records || 0);
                        resultsHtml += `
                            <div class="file-item success">
                                <span>âœ… ${file.name}</span>
                                <span>${result.records || 0} Ø±Ú©ÙˆØ±Ø¯</span>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="file-item error">
                                <span>âŒ ${file.name}</span>
                                <span>${result.error || 'Ø®Ø·Ø§'}</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="file-item error">
                            <span>âŒ ${file.name}</span>
                            <span>Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡</span>
                        </div>
                    `;
                }
            }

            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
            statusDiv.innerHTML = resultsHtml;
            updateRunButton();
        }

        // Global object to store test parameters
        let testParametersData = new Map();

        async function loadTestParameters() {
            const container = document.getElementById('parametersContainer');
            const section = document.getElementById('parametersSection');

            testParametersData.clear();
            container.innerHTML = '';

            let hasParameters = false;

            for (const [testId, test] of selectedTests) {
                try {
                    const response = await fetch(`/get-test-parameters/${testId}`);
                    const data = await response.json();

                    if (data.success && data.parameters && data.parameters.length > 0) {
                        hasParameters = true;
                        testParametersData.set(testId, data.parameters);
                        renderTestParameters(testId, test, data.parameters);
                    }
                } catch (error) {
                    console.error(`Error loading parameters for ${testId}:`, error);
                }
            }

            section.style.display = hasParameters ? 'block' : 'none';
        }

        function renderTestParameters(testId, test, parameters) {
            const container = document.getElementById('parametersContainer');

            const card = document.createElement('div');
            card.className = 'test-parameters-card';
            card.id = `params-${testId}`;

            let html = `
                <div class="test-parameters-header">
                    <span style="font-size: 1.5em;">${test.icon}</span>
                    <h4>${test.name}</h4>
                </div>
                <div class="parameter-form">
            `;

            parameters.forEach(param => {
                html += renderParameter(testId, param);
            });

            html += '</div>';
            card.innerHTML = html;
            container.appendChild(card);
        }

        function renderParameter(testId, param) {
            const inputId = `param-${testId}-${param.key}`;
            const required = param.required ? '<span class="param-required">*</span>' : '';

            let inputHtml = '';

            switch (param.type) {
                case 'number':
                    inputHtml = `
                        <input type="number" 
                            id="${inputId}" 
                            class="param-input" 
                            value="${param.defaultValue || ''}"
                            ${param.required ? 'required' : ''}
                            step="any">
                    `;
                    break;

                case 'string':
                    inputHtml = `
                        <input type="text" 
                            id="${inputId}" 
                            class="param-input" 
                            value="${param.defaultValue || ''}"
                            ${param.required ? 'required' : ''}>
                    `;
                    break;

                case 'date':
                    inputHtml = `
                        <input type="date" 
                            id="${inputId}" 
                            class="param-input" 
                            value="${param.defaultValue || ''}"
                            ${param.required ? 'required' : ''}>
                    `;
                    break;

                case 'datetime':
                    inputHtml = `
                        <input type="datetime-local" 
                            id="${inputId}" 
                            class="param-input" 
                            value="${param.defaultValue || ''}"
                            ${param.required ? 'required' : ''}>
                    `;
                    break;

                case 'boolean':
                    inputHtml = `
                        <div class="param-checkbox-container">
                            <input type="checkbox" 
                                id="${inputId}" 
                                class="param-checkbox" 
                                ${param.defaultValue ? 'checked' : ''}>
                            <label for="${inputId}">ÙØ¹Ø§Ù„</label>
                        </div>
                    `;
                    break;

                case 'select':
                    inputHtml = `<select id="${inputId}" class="param-select" ${param.required ? 'required' : ''}>`;
                    if (param.options) {
                        param.options.forEach(option => {
                            const selected = option.value == param.defaultValue ? 'selected' : '';
                            inputHtml += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                        });
                    }
                    inputHtml += '</select>';
                    break;

                default:
                    inputHtml = `
                        <input type="text" 
                            id="${inputId}" 
                            class="param-input" 
                            value="${param.defaultValue || ''}">
                    `;
            }

            return `
                <div class="param-group">
                    <label class="param-label" for="${inputId}">
                        ${required}${param.displayName}
                    </label>
                    ${inputHtml}
                </div>
            `;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape for use in onclick attribute
        function escapeForAttribute(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/`/g, '\\`');
        }

        function collectTestParameters(testId) {
            const params = {};
            const testParams = testParametersData.get(testId);

            if (!testParams) {
                return params;
            }

            testParams.forEach(param => {
                const inputId = `param-${testId}-${param.key}`;
                const element = document.getElementById(inputId);

                if (element) {
                    if (param.type === 'boolean') {
                        params[param.key] = element.checked;
                    } else if (param.type === 'number') {
                        const value = parseFloat(element.value);
                        params[param.key] = isNaN(value) ? param.defaultValue : value;
                    } else {
                        params[param.key] = element.value || param.defaultValue;
                    }
                }
            });

            return params;
        }

        // Update run button state
        function updateRunButton() {
            const btnRun = document.getElementById('btnRun');
            btnRun.disabled = !(selectedTests.size > 0 && uploadedFiles.size > 0);
        }

        // Run tests
        async function runTests() {
            const resultsContainer = document.getElementById('resultsContainer');
            const btnRun = document.getElementById('btnRun');
            
            btnRun.disabled = true;
            testResults = [];

            // Show progress
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                </div>
            `;

            const testIds = Array.from(selectedTests.keys());
            let completed = 0;

            for (let testId of testIds) {
                const test = selectedTests.get(testId);
                
                try {
                    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†
                    const params = collectTestParameters(testId);
                    
                    const response = await fetch(`/run-test/${testId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    });

                    const result = await response.json();
                    result.test_name = test.name;
                    result.test_icon = test.icon;
                    result.test_id = testId;
                    testResults.push(result);

                } catch (error) {
                    testResults.push({
                        test_id: testId,
                        test_name: test.name,
                        test_icon: test.icon,
                        success: false,
                        error: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§: ' + error.message
                    });
                }

                completed++;
                const progress = Math.round((completed / testIds.length) * 100);
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }

            // Display results
            displayResults();
            btnRun.disabled = false;
        }

        // Display results with interpretation
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            let html = '';

            for (let result of testResults) {
                const isSuccess = result.success !== false && !result.error;
                const statusClass = isSuccess ? 'success' : 'error';
                const statusIcon = isSuccess ? 'âœ…' : 'âŒ';

                html += `
                    <div class="result-card ${statusClass}">
                        <div class="result-header">
                            <div class="result-title">${result.test_icon} ${result.test_name}</div>
                            <div class="result-status">${statusIcon}</div>
                        </div>
                `;

                if (result.error) {
                    const displayError = escapeHtml(result.error);
                    const safeTestId = escapeHtml(result.test_id);
                    
                    // Store error data in a global map for safe access
                    if (!window.testErrorData) {
                        window.testErrorData = new Map();
                    }
                    window.testErrorData.set(result.test_id, {
                        error: result.error,
                        traceback: result.traceback || ''
                    });
                    
                    html += `
                        <div style="margin: 15px 0;">
                            <p style="color: #dc3545; font-weight: bold; margin-bottom: 10px;">Ø®Ø·Ø§: ${displayError}</p>
                            <button class="btn-fix-error" data-test-id="${safeTestId}">
                                ğŸ”§ Ø§ØµÙ„Ø§Ø­ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
                            </button>
                        </div>
                    `;
                } else {
                    // Stats
                    html += `<div class="result-stats">`;
                    if (result.count !== undefined) {
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div>
                                <div class="stat-value">${result.count.toLocaleString('fa-IR')}</div>
                            </div>
                        `;
                    }
                    if (result.execution_time) {
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§</div>
                                <div class="stat-value">${result.execution_time}</div>
                            </div>
                        `;
                    }
                    html += `</div>`;

                    // Interpretation
                    const interpretation = generateInterpretation(result);
                    if (interpretation) {
                        html += `
                            <div class="interpretation-box">
                                <h5>ğŸ’¡ ØªÙØ³ÛŒØ± Ùˆ ØªØ­Ù„ÛŒÙ„</h5>
                                <p>${interpretation}</p>
                            </div>
                        `;
                    }

                    // Results table
                    if (result.results && result.results.length > 0) {
                        html += `<div class="result-table">`;
                        html += `<h4 style="margin: 15px 0; color: #667eea;">ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª (Ù†Ù…Ø§ÛŒØ´ ${Math.min(10, result.results.length)} Ø§Ø² ${result.count} Ø±Ú©ÙˆØ±Ø¯):</h4>`;
                        html += `<table><thead><tr>`;
                        
                        const keys = Object.keys(result.results[0]);
                        keys.forEach(key => {
                            html += `<th>${key}</th>`;
                        });
                        html += `</tr></thead><tbody>`;

                        result.results.slice(0, 10).forEach(row => {
                            html += `<tr>`;
                            keys.forEach(key => {
                                let value = row[key];
                                if (typeof value === 'number') {
                                    value = value.toLocaleString('fa-IR');
                                }
                                html += `<td>${value || '-'}</td>`;
                            });
                            html += `</tr>`;
                        });

                        html += `</tbody></table></div>`;
                    }

                    // Export button
                    if (result.count > 0) {
                        html += `
                            <div style="text-align: center; margin-top: 15px;">
                                <button class="btn-export" onclick="exportResult('${result.test_id}')">
                                    ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel
                                </button>
                            </div>
                        `;
                    }
                }

                html += `</div>`;
            }

            container.innerHTML = html;
            
            // Add event listeners to fix-error buttons
            document.querySelectorAll('.btn-fix-error').forEach(button => {
                button.addEventListener('click', function() {
                    const testId = this.getAttribute('data-test-id');
                    if (testId && window.testErrorData && window.testErrorData.has(testId)) {
                        const errorData = window.testErrorData.get(testId);
                        fixTestError(testId, errorData.error, errorData.traceback);
                    }
                });
            });
        }

        // Generate interpretation based on results
        function generateInterpretation(result) {
            if (result.count === undefined || result.count === null) return null;

            const testId = result.test_id;
            const count = result.count;

            // Benford tests
            if (testId.includes('benford')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ø§Ù†Ø­Ø±Ø§Ù Ø§Ø² Ù‚Ø§Ù†ÙˆÙ† Ø¨Ù†ÙÙˆØ±Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù†Ø´Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ ØºÛŒØ±Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ø§Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`;
                } else {
                    return `âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù‚Ø§Ù†ÙˆÙ† Ø¨Ù†ÙÙˆØ±Ø¯ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ù†Ø¯ Ùˆ Ø§Ù„Ú¯ÙˆÛŒ Ø·Ø¨ÛŒØ¹ÛŒ Ø¯Ø§Ø±Ù†Ø¯.`;
                }
            }

            // Duplicate tests
            if (testId.includes('duplicate')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ ÛŒØ§ÙØª Ø´Ø¯. Ù…ÙˆØ§Ø±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ø´Ø§Ù†Ù‡ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø«Ø¨ØªØŒ ØªÙ‚Ù„Ø¨ ÛŒØ§ Ù†ÙˆØ§Ù‚Øµ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¨Ø§Ø´Ø¯.`;
                } else {
                    return `âœ… Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // High value transactions
            if (testId.includes('high_value')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø¨Ø§Ù„Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ£ÛŒÛŒØ¯ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø§Ø±Ù†Ø¯.`;
                } else {
                    return `âœ… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø§Ø±Ø²Ø´ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // Fraud tests
            if (testId.includes('fraud')) {
                if (count > 0) {
                    return `ğŸš¨ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ù…Ø´Ú©ÙˆÚ© Ø¨Ù‡ ØªÙ‚Ù„Ø¨ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ ÙÙˆØ±ÛŒ Ùˆ Ø¹Ù…ÛŒÙ‚ Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª.`;
                } else {
                    return `âœ… Ø´ÙˆØ§Ù‡Ø¯ÛŒ Ø§Ø² ØªÙ‚Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // Statistical tests
            if (testId.includes('statistical') || testId.includes('zscore') || testId.includes('iqr')) {
                if (count > 0) {
                    return `ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡ ÙˆÛŒÚ˜Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯.`;
                } else {
                    return `âœ… ØªÙ…Ø§Ù… Ù…ÙˆØ§Ø±Ø¯ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯.`;
                }
            }

            // Default interpretation
            if (count > 0) {
                return `ğŸ“Œ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ ÛŒØ§ÙØª Ø´Ø¯ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ø¯.`;
            } else {
                return `âœ… Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
            }
        }

        // Export single result
        async function exportResult(testId) {
            try {
                const response = await fetch(`/export/${testId}`, {
                    method: 'GET'
                });
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0,10);
                a.download = `${testId}_${dateStr}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„: ' + error.message);
            }
        }

        // Fix test error using AI
        async function fixTestError(testId, errorMessage, traceback) {
            console.log('ğŸ”§ fixTestError called with:', { testId, errorMessage, traceback });
            
            if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ Ø§ÛŒÙ† Ø®Ø·Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ØŸ\n\nØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø¯ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ ØªØºÛŒÛŒØ± Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø¯ Ùˆ ÛŒÚ© Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.')) {
                console.log('âŒ User cancelled fix operation');
                return;
            }

            // Find the button and disable it
            const buttons = document.querySelectorAll('.btn-fix-error');
            console.log(`ğŸ”˜ Found ${buttons.length} fix buttons`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØµÙ„Ø§Ø­...';
            });

            try {
                console.log('ğŸ“¤ Sending fix request to server...');
                const response = await fetch('/fix-test-error', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test_id: testId,
                        error_message: errorMessage,
                        traceback: traceback
                    })
                });
                
                console.log('ğŸ“¥ Response status:', response.status);

                const result = await response.json();
                console.log('ğŸ“Š Result:', result);

                if (result.success) {
                    console.log('âœ… Fix successful!');
                    alert(`âœ… ${result.message}\n\nÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†: ${result.backup_file}\n\nÙ„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.`);
                    
                    // Re-run the test automatically
                    if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¢Ø²Ù…ÙˆÙ† Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø±Ø§ ÙÙˆØ±Ø§Ù‹ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ØŸ')) {
                        console.log('ğŸ”„ Re-running test...');
                        // Clear previous results for this test
                        testResults = testResults.filter(r => r.test_id !== testId);
                        
                        // Run the fixed test
                        const test = selectedTests.get(testId);
                        if (test) {
                            try {
                                const params = collectTestParameters(testId);
                                const testResponse = await fetch(`/run-test/${testId}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(params)
                                });

                                const testResult = await testResponse.json();
                                testResult.test_name = test.name;
                                testResult.test_icon = test.icon;
                                testResult.test_id = testId;
                                testResults.push(testResult);

                                // Re-display results
                                displayResults();
                                console.log('âœ… Test re-run complete');
                            } catch (error) {
                                console.error('âŒ Error re-running test:', error);
                                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¢Ø²Ù…ÙˆÙ†: ' + error.message);
                            }
                        }
                    }
                } else {
                    console.error('âŒ Fix failed:', result.error);
                    alert(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØµÙ„Ø§Ø­: ${result.error}`);
                }
            } catch (error) {
                console.error('âŒ Error in fixTestError:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + error.message);
            } finally {
                console.log('ğŸ”„ Re-enabling buttons...');
                // Re-enable buttons
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ”§ Ø§ØµÙ„Ø§Ø­ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ';
                });
            }
        }

        // Reset all
        function resetAll() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                selectedTests.clear();
                uploadedFiles.clear();
                testResults = [];
                testParametersData.clear();
                
                // Clear selections
                document.querySelectorAll('.test-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Reset UI
                updateSelectedBadges();
                document.getElementById('fileStatus').innerHTML = '';
                document.getElementById('parametersSection').style.display = 'none';
                document.getElementById('parametersContainer').innerHTML = '';
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="no-selection">
                        <div class="no-selection-icon">ğŸ“ˆ</div>
                        <p>Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ØŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯</p>
                    </div>
                `;
                updateRunButton();
            }
        }
    </script>
</body>
</html>
