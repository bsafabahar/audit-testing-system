<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</title>
    <!-- Vazir Persian Font from official CDN -->
    <!-- This is the official repository for Vazir font: https://github.com/rastikerdar/vazir-font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" type="text/css" />
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.3em;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.95;
        }

        /* Main Layout: Tree Menu (Right) + Content Area (Left) */
        .main-content {
            display: flex;
            flex: 1;
            overflow: visible;
        }

        /* Content Area - Contains Top Panel & Results */
        .content-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: visible;
        }

        /* Top Panel - Settings & Files */
        .top-panel {
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            padding: 20px;
            overflow: visible;
        }

        .top-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-section {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-info {
            margin-bottom: 15px;
        }

        .test-info h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .test-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.95em;
        }

        .upload-section {
            margin-top: 15px;
        }

        .upload-box {
            background: white;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: #f8f9fa;
            border-color: #764ba2;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .file-status {
            margin-top: 15px;
        }

        .file-item {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item.success {
            background: #d4edda;
            border-right: 4px solid #28a745;
        }

        .file-item.error {
            background: #f8d7da;
            border-right: 4px solid #dc3545;
        }

        /* Bottom Content: Tree Menu (Right) + Results (Left) */
        .bottom-content {
            display: flex;
            flex: 1;
            overflow: visible;
        }

        /* Results Area (Left/Main) */
        .results-area {
            flex: 1;
            padding: 20px;
            overflow: visible;
            background: #fafafa;
        }

        .results-area h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border-right: 5px solid #667eea;
        }

        .result-card.success {
            border-right-color: #28a745;
        }

        .result-card.error {
            border-right-color: #dc3545;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #333;
            font-size: 1.3em;
            font-weight: bold;
        }

        .interpretation-box {
            background: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .interpretation-box h5 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .interpretation-box p {
            color: #856404;
            line-height: 1.6;
        }

        .result-table {
            overflow-x: auto;
            margin-top: 15px;
        }

        .result-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .result-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: right;
            font-weight: bold;
        }

        .result-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            text-align: right;
        }

        .result-table tr:hover {
            background: #f8f9fa;
        }

        /* Tree Menu (Right Sidebar) */
        .tree-menu {
            width: 350px;
            min-width: 350px;
            background: #ffffff;
            border-left: 3px solid #667eea;
            overflow: visible;
            padding: 20px;
            flex-shrink: 0;
        }

        .tree-menu h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* View Toggle Buttons */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .view-btn {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Vazir', 'Tahoma', 'Arial', sans-serif;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .view-btn span:first-child {
            font-size: 1.3em;
        }

        .view-btn:hover {
            background: #e7f3ff;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            font-weight: bold;
        }

        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        .tree-category {
            margin-bottom: 10px;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            font-weight: bold;
        }

        .category-header:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .category-header.active {
            border-radius: 8px 8px 0 0;
        }

        .category-count {
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .test-list {
            display: none;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .test-list.active {
            display: block;
        }

        .test-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-item:hover {
            background: #e7f3ff;
            padding-right: 20px;
        }

        .test-item.selected {
            background: #d4edda;
            font-weight: bold;
        }

        .test-icon {
            font-size: 1.2em;
        }

        .test-name {
            flex: 1;
            font-size: 0.95em;
        }

        /* Run Button (Bottom Fixed) */
        .run-button-container {
            background: white;
            border-top: 3px solid #667eea;
            padding: 20px;
            text-align: center;
        }

        .btn-run {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-run:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-run:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-run:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-export {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.3);
        }

        /* Loading & Progress */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .no-selection {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-selection-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Info Button */
        .info-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
        }

        .info-btn:hover {
            background: #138496;
            transform: scale(1.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            direction: rtl;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            line-height: 1.8;
        }

        /* Markdown Styling */
        .markdown-content h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-top: 20px;
            font-size: 1.8em;
        }

        .markdown-content h2 {
            color: #764ba2;
            margin-top: 25px;
            font-size: 1.5em;
            border-right: 4px solid #764ba2;
            padding-right: 15px;
        }

        .markdown-content h3 {
            color: #667eea;
            margin-top: 20px;
            font-size: 1.3em;
        }

        .markdown-content p {
            margin: 15px 0;
            text-align: justify;
        }

        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-right: 30px;
        }

        .markdown-content li {
            margin: 8px 0;
        }

        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }

        .markdown-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid #667eea;
            overflow-x: auto;
        }

        .markdown-content blockquote {
            background: #fff3cd;
            border-right: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .markdown-content th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: right;
        }

        .markdown-content td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
        }

        .markdown-content tr:nth-child(even) {
            background: #f8f9fa;
        }

        .loading-modal {
            text-align: center;
            padding: 40px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .tree-menu {
                width: 300px;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .tree-menu {
                width: 100%;
                min-width: auto;
                max-height: 300px;
                border-left: none;
                border-bottom: 3px solid #667eea;
                order: -1;
            }

            .container {
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ Ø³ÛŒØ³ØªÙ… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</h1>
            <p>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§: <strong>{{ total_tests }}</strong> Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø± <strong>{{ total_categories }}</strong> Ø¯Ø³ØªÙ‡</p>
        </div>

        <div class="main-content">
            <!-- Tree Menu (Right Sidebar) - Full Height -->
            <div class="tree-menu">
                <h3>ğŸ“‚ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h3>
                
                <!-- View Toggle Buttons -->
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('category')" id="viewBtnCategory">
                        <span>ğŸ“‚</span>
                        <span>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÙˆØ¶ÙˆØ¹ÛŒ</span>
                    </button>
                    <button class="view-btn" onclick="switchView('subsystem')" id="viewBtnSubsystem">
                        <span>ğŸ¦</span>
                        <span>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø²ÛŒØ±Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</span>
                    </button>
                </div>

                <!-- Category View -->
                <div class="view-content active" id="categoryView">
                    {% for category_id, category in audit_tests.items() %}
                    <div class="tree-category">
                        <div class="category-header" onclick="toggleCategory('{{ category_id }}')">
                            <span>{{ category.name }}</span>
                            <span class="category-count">{{ category.tests|length }}</span>
                        </div>
                        <div class="test-list" id="list-{{ category_id }}">
                            {% for test in category.tests %}
                            <div class="test-item" id="item-{{ test.id }}">
                                <button class="info-btn" onclick="event.stopPropagation(); showTestInfo('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')" title="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±">â„¹ï¸</button>
                                <span class="test-icon" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.icon }}</span>
                                <span class="test-name" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Subsystem View -->
                <div class="view-content" id="subsystemView">
                    {% for subsystem_id, subsystem in subsystems.items() %}
                    <div class="tree-category">
                        <div class="category-header" onclick="toggleCategory('sub-{{ subsystem_id }}')">
                            <span>{{ subsystem.icon }} {{ subsystem.name }}</span>
                            <span class="category-count">{{ subsystem.tests|length }}</span>
                        </div>
                        <div class="test-list" id="list-sub-{{ subsystem_id }}">
                            {% for test in subsystem.tests %}
                            <div class="test-item" id="item-sub-{{ subsystem_id }}-{{ test.id }}">
                                <button class="info-btn" onclick="event.stopPropagation(); showTestInfo('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')" title="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±">â„¹ï¸</button>
                                <span class="test-icon" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.icon }}</span>
                                <span class="test-name" onclick="selectTest('{{ test.id }}', '{{ test.name }}', '{{ test.icon }}')">{{ test.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Content Area - Settings & Results -->
            <div class="content-area">
                <!-- Top Panel: Settings & File Upload -->
                <div class="top-panel">
                    <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†</h3>
                    
                    <div class="settings-section">
                        <div class="test-info">
                            <h4>Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</h4>
                            <div id="selectedTestBadges">
                                <div class="no-selection">
                                    <div class="no-selection-icon">ğŸ“‹</div>
                                    <p>Ù‡ÛŒÚ† Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                                    <p style="font-size: 0.9em; margin-top: 10px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                                </div>
                            </div>
                        </div>

                        <div class="upload-section" id="uploadSection" style="display: none;">
                            <h4>ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡:</h4>
                            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple onchange="uploadFiles()">
                                <div class="upload-icon">ğŸ“</div>
                                <h3>Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯</h3>
                                <p>ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²: Excel (.xlsx, .xls)</p>
                            </div>
                            <div class="file-status" id="fileStatus"></div>
                        </div>
                    </div>
                </div>

                <!-- Results Area -->
                <div class="bottom-content">
                    <div class="results-area">
                        <h3>ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</h3>
                        <div id="resultsContainer">
                            <div class="no-selection">
                                <div class="no-selection-icon">ğŸ“ˆ</div>
                                <p>Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ØŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Run Button (Bottom Fixed) -->
        <div class="run-button-container">
            <button class="btn-secondary" onclick="resetAll()">ğŸ”„ Ø±ÛŒØ³Øª Ù‡Ù…Ù‡</button>
            <button class="btn-run" id="btnRun" onclick="runTests()" disabled>
                â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§
            </button>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">ğŸ“– Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø²Ù…ÙˆÙ†</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="modalContent" class="markdown-content">
                    <div class="loading-modal">
                        <div class="spinner"></div>
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedTests = new Map();
        let uploadedFiles = new Map();
        let testResults = [];

        // Toggle category expansion
        function toggleCategory(categoryId) {
            const list = document.getElementById('list-' + categoryId);
            const header = list.previousElementSibling;
            
            if (list.classList.contains('active')) {
                list.classList.remove('active');
                header.classList.remove('active');
            } else {
                list.classList.add('active');
                header.classList.add('active');
            }
        }

        // Switch between category and subsystem views
        function switchView(viewType) {
            const categoryView = document.getElementById('categoryView');
            const subsystemView = document.getElementById('subsystemView');
            const categoryBtn = document.getElementById('viewBtnCategory');
            const subsystemBtn = document.getElementById('viewBtnSubsystem');

            if (viewType === 'category') {
                categoryView.classList.add('active');
                subsystemView.classList.remove('active');
                categoryBtn.classList.add('active');
                subsystemBtn.classList.remove('active');
            } else {
                categoryView.classList.remove('active');
                subsystemView.classList.add('active');
                categoryBtn.classList.remove('active');
                subsystemBtn.classList.add('active');
            }
        }

        // Show test info modal
        async function showTestInfo(testId, testName, testIcon) {
            const modal = document.getElementById('infoModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.innerHTML = `${testIcon} ${testName}`;
            modalContent.innerHTML = `
                <div class="loading-modal">
                    <div class="spinner"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                </div>
            `;
            
            modal.classList.add('active');
            
            try {
                const response = await fetch(`/test-description/${testId}`);
                const data = await response.json();
                
                if (data.success && data.description) {
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² marked.js Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ markdown Ø¨Ù‡ HTML
                    if (typeof marked !== 'undefined') {
                        marked.setOptions({
                            breaks: true,
                            gfm: true
                        });
                        modalContent.innerHTML = marked.parse(data.description);
                    } else {
                        // ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø¯Ù‡ Ø§Ú¯Ø± marked.js Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡
                        let html = data.description;
                        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
                        html = html.replace(/^## (.+)$/gm, '<h2>$2</h2>');
                        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
                        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
                        html = html.replace(/^\- (.+)$/gm, '<li>$1</li>');
                        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                        html = html.split('\n\n').map(para => '<p>' + para + '</p>').join('\n');
                        modalContent.innerHTML = html;
                    }
                } else {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: #dc3545; font-size: 1.2em;">âš ï¸ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                            <p style="color: #6c757d; margin-top: 10px;">ÙØ§ÛŒÙ„ ${testId}.md Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>
                        </div>
                    `;
                }
            } catch (error) {
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: #dc3545; font-size: 1.2em;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>
                        <p style="color: #6c757d; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.remove('active');
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Select/deselect test
        async function selectTest(testId, testName, testIcon) {
            // Handle both category and subsystem view items
            const categoryItem = document.getElementById('item-' + testId);
            
            // Get all subsystem view instances of this test
            const allItems = document.querySelectorAll(`[id*="-${testId}"]`);
            
            if (selectedTests.has(testId)) {
                selectedTests.delete(testId);
                // Remove selected class from all instances
                if (categoryItem) categoryItem.classList.remove('selected');
                allItems.forEach(item => item.classList.remove('selected'));
            } else {
                // Ø¯Ø±ÛŒØ§ÙØª Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ†
                try {
                    const response = await fetch(`/test-requirements/${testId}`);
                    const data = await response.json();
                    const requirements = data.success ? data.requirements : null;
                    
                    selectedTests.set(testId, { 
                        name: testName, 
                        icon: testIcon,
                        requirements: requirements 
                    });
                } catch (error) {
                    selectedTests.set(testId, { 
                        name: testName, 
                        icon: testIcon,
                        requirements: null
                    });
                }
                // Add selected class to all instances
                if (categoryItem) categoryItem.classList.add('selected');
                allItems.forEach(item => item.classList.add('selected'));
            }
            
            updateSelectedBadges();
            updateRunButton();
        }

        // Update selected test badges in top panel
        async function updateSelectedBadges() {
            const container = document.getElementById('selectedTestBadges');
            const uploadSection = document.getElementById('uploadSection');
            
            if (selectedTests.size === 0) {
                container.innerHTML = `
                    <div class="no-selection">
                        <div class="no-selection-icon">ğŸ“‹</div>
                        <p>Ù‡ÛŒÚ† Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                    </div>
                `;
                uploadSection.style.display = 'none';
                return;
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            let html = '<div style="margin-bottom: 15px;">';
            selectedTests.forEach((test, id) => {
                html += `<span class="test-badge">${test.icon} ${test.name}</span>`;
            });
            html += '</div>';
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            html += `<div id="filesRequiredBox" style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center;">
                <span style="color: #667eea;">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²...</span>
            </div>`;
            
            container.innerHTML = html;
            
            // Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
            const testIds = Array.from(selectedTests.keys());
            try {
                const response = await fetch('/tests-requirements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_ids: testIds })
                });
                const data = await response.json();
                
                console.log('Requirements response:', data);
                
                let filesHtml = '';
                if (data.success && data.files && data.files.length > 0) {
                    filesHtml = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 10px; font-size: 1.05em;">ğŸ“‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</h4>
                            <div style="color: #856404; font-size: 0.95em; line-height: 1.8;">
                    `;
                    data.files.forEach(file => {
                        filesHtml += `<div style="padding: 5px 0; font-weight: bold;">âœ“ ${file}</div>`;
                    });
                    filesHtml += `
                            </div>
                            <p style="margin-top: 10px; font-size: 0.85em; color: #856404; font-style: italic;">
                                ğŸ’¡ Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ù¾ÙˆØ´Ù‡ excel_sample_data Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
                            </p>
                        </div>
                    `;
                } else {
                    filesHtml = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #dc3545;">
                            <p style="color: #721c24;">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                        </div>
                    `;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§Ú©Ø³
                const filesBox = document.getElementById('filesRequiredBox');
                if (filesBox) {
                    filesBox.outerHTML = filesHtml;
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§:', error);
                const filesBox = document.getElementById('filesRequiredBox');
                if (filesBox) {
                    filesBox.outerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-top: 15px; border-right: 4px solid #dc3545;">
                            <p style="color: #721c24;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ${error.message}</p>
                        </div>
                    `;
                }
            }
            
            uploadSection.style.display = 'block';
        }

        // Upload files
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;

            const statusDiv = document.getElementById('fileStatus');
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§...</p></div>';

            let resultsHtml = '';
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success || result.records) {
                        uploadedFiles.set(file.name, result.records || 0);
                        resultsHtml += `
                            <div class="file-item success">
                                <span>âœ… ${file.name}</span>
                                <span>${result.records || 0} Ø±Ú©ÙˆØ±Ø¯</span>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="file-item error">
                                <span>âŒ ${file.name}</span>
                                <span>${result.error || 'Ø®Ø·Ø§'}</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    resultsHtml += `
                        <div class="file-item error">
                            <span>âŒ ${file.name}</span>
                            <span>Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡</span>
                        </div>
                    `;
                }
            }

            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
            statusDiv.innerHTML = resultsHtml;
            updateRunButton();
        }

        // Update run button state
        function updateRunButton() {
            const btnRun = document.getElementById('btnRun');
            btnRun.disabled = !(selectedTests.size > 0 && uploadedFiles.size > 0);
        }

        // Run tests
        async function runTests() {
            const resultsContainer = document.getElementById('resultsContainer');
            const btnRun = document.getElementById('btnRun');
            
            btnRun.disabled = true;
            testResults = [];

            // Show progress
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                </div>
            `;

            const testIds = Array.from(selectedTests.keys());
            let completed = 0;

            for (let testId of testIds) {
                const test = selectedTests.get(testId);
                
                try {
                    const response = await fetch(`/run-test/${testId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    const result = await response.json();
                    result.test_name = test.name;
                    result.test_icon = test.icon;
                    result.test_id = testId;
                    testResults.push(result);

                } catch (error) {
                    testResults.push({
                        test_id: testId,
                        test_name: test.name,
                        test_icon: test.icon,
                        success: false,
                        error: 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§: ' + error.message
                    });
                }

                completed++;
                const progress = Math.round((completed / testIds.length) * 100);
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                }
            }

            // Display results
            displayResults();
            btnRun.disabled = false;
        }

        // Display results with interpretation
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            let html = '';

            for (let result of testResults) {
                const isSuccess = result.success !== false && !result.error;
                const statusClass = isSuccess ? 'success' : 'error';
                const statusIcon = isSuccess ? 'âœ…' : 'âŒ';

                html += `
                    <div class="result-card ${statusClass}">
                        <div class="result-header">
                            <div class="result-title">${result.test_icon} ${result.test_name}</div>
                            <div class="result-status">${statusIcon}</div>
                        </div>
                `;

                if (result.error) {
                    html += `<p style="color: #dc3545; font-weight: bold;">Ø®Ø·Ø§: ${result.error}</p>`;
                } else {
                    // Stats
                    html += `<div class="result-stats">`;
                    if (result.count !== undefined) {
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</div>
                                <div class="stat-value">${result.count.toLocaleString('fa-IR')}</div>
                            </div>
                        `;
                    }
                    if (result.execution_time) {
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§</div>
                                <div class="stat-value">${result.execution_time}</div>
                            </div>
                        `;
                    }
                    html += `</div>`;

                    // Interpretation
                    const interpretation = generateInterpretation(result);
                    if (interpretation) {
                        html += `
                            <div class="interpretation-box">
                                <h5>ğŸ’¡ ØªÙØ³ÛŒØ± Ùˆ ØªØ­Ù„ÛŒÙ„</h5>
                                <p>${interpretation}</p>
                            </div>
                        `;
                    }

                    // Results table
                    if (result.results && result.results.length > 0) {
                        html += `<div class="result-table">`;
                        html += `<h4 style="margin: 15px 0; color: #667eea;">ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª (Ù†Ù…Ø§ÛŒØ´ ${Math.min(10, result.results.length)} Ø§Ø² ${result.count} Ø±Ú©ÙˆØ±Ø¯):</h4>`;
                        html += `<table><thead><tr>`;
                        
                        const keys = Object.keys(result.results[0]);
                        keys.forEach(key => {
                            html += `<th>${key}</th>`;
                        });
                        html += `</tr></thead><tbody>`;

                        result.results.slice(0, 10).forEach(row => {
                            html += `<tr>`;
                            keys.forEach(key => {
                                let value = row[key];
                                if (typeof value === 'number') {
                                    value = value.toLocaleString('fa-IR');
                                }
                                html += `<td>${value || '-'}</td>`;
                            });
                            html += `</tr>`;
                        });

                        html += `</tbody></table></div>`;
                    }

                    // Export button
                    if (result.count > 0) {
                        html += `
                            <div style="text-align: center; margin-top: 15px;">
                                <button class="btn-export" onclick="exportResult('${result.test_id}')">
                                    ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel
                                </button>
                            </div>
                        `;
                    }
                }

                html += `</div>`;
            }

            container.innerHTML = html;
        }

        // Generate interpretation based on results
        function generateInterpretation(result) {
            if (result.count === undefined || result.count === null) return null;

            const testId = result.test_id;
            const count = result.count;

            // Benford tests
            if (testId.includes('benford')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ø§Ù†Ø­Ø±Ø§Ù Ø§Ø² Ù‚Ø§Ù†ÙˆÙ† Ø¨Ù†ÙÙˆØ±Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù†Ø´Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ ØºÛŒØ±Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ø§Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`;
                } else {
                    return `âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù‚Ø§Ù†ÙˆÙ† Ø¨Ù†ÙÙˆØ±Ø¯ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ù†Ø¯ Ùˆ Ø§Ù„Ú¯ÙˆÛŒ Ø·Ø¨ÛŒØ¹ÛŒ Ø¯Ø§Ø±Ù†Ø¯.`;
                }
            }

            // Duplicate tests
            if (testId.includes('duplicate')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ ÛŒØ§ÙØª Ø´Ø¯. Ù…ÙˆØ§Ø±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ø´Ø§Ù†Ù‡ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø«Ø¨ØªØŒ ØªÙ‚Ù„Ø¨ ÛŒØ§ Ù†ÙˆØ§Ù‚Øµ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¨Ø§Ø´Ø¯.`;
                } else {
                    return `âœ… Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ ØªÚ©Ø±Ø§Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // High value transactions
            if (testId.includes('high_value')) {
                if (count > 0) {
                    return `âš ï¸ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø¨Ø§Ù„Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ£ÛŒÛŒØ¯ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø§Ø±Ù†Ø¯.`;
                } else {
                    return `âœ… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø§Ø±Ø²Ø´ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // Fraud tests
            if (testId.includes('fraud')) {
                if (count > 0) {
                    return `ğŸš¨ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ù…Ø´Ú©ÙˆÚ© Ø¨Ù‡ ØªÙ‚Ù„Ø¨ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ ÙÙˆØ±ÛŒ Ùˆ Ø¹Ù…ÛŒÙ‚ Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª.`;
                } else {
                    return `âœ… Ø´ÙˆØ§Ù‡Ø¯ÛŒ Ø§Ø² ØªÙ‚Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
                }
            }

            // Statistical tests
            if (testId.includes('statistical') || testId.includes('zscore') || testId.includes('iqr')) {
                if (count > 0) {
                    return `ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡ ÙˆÛŒÚ˜Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯.`;
                } else {
                    return `âœ… ØªÙ…Ø§Ù… Ù…ÙˆØ§Ø±Ø¯ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø·Ø¨ÛŒØ¹ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯.`;
                }
            }

            // Default interpretation
            if (count > 0) {
                return `ğŸ“Œ ØªØ¹Ø¯Ø§Ø¯ ${count.toLocaleString('fa-IR')} Ù…ÙˆØ±Ø¯ ÛŒØ§ÙØª Ø´Ø¯ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ø¯.`;
            } else {
                return `âœ… Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.`;
            }
        }

        // Export single result
        async function exportResult(testId) {
            try {
                const response = await fetch(`/export/${testId}`, {
                    method: 'GET'
                });
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0,10);
                a.download = `${testId}_${dateStr}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„: ' + error.message);
            }
        }

        // Reset all
        function resetAll() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                selectedTests.clear();
                uploadedFiles.clear();
                testResults = [];
                
                // Clear selections
                document.querySelectorAll('.test-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Reset UI
                updateSelectedBadges();
                document.getElementById('fileStatus').innerHTML = '';
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="no-selection">
                        <div class="no-selection-icon">ğŸ“ˆ</div>
                        <p>Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ØŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯</p>
                    </div>
                `;
                updateRunButton();
            }
        }
    </script>
</body>
</html>
